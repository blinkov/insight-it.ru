<!DOCTYPE html>
<html lang=ru xmlns=http://www.w3.org/1999/xhtml xmlns:og=http://ogp.me/ns# xmlns:fb=https://www.facebook.com/2008/fbml><head><meta http-equiv=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=msapplication-tap-highlight content=no><title>Защита интернет-ресурсов в картинках</title><link href="//fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=PT+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link rel=stylesheet href=https://www.insight-it.ru/theme/css/main.css?969f431c><link rel=canonical href=https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/ ><meta property=og:url content=https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/ ><meta property=og:title content="Защита интернет-ресурсов в картинках"><meta property=og:type content=article><meta name=description content="Этой статьей мне хотелось бы открыть мою первую серию статей " джентельменский набор php программиста". как и во всей ..."><meta property=og:description content="Этой статьей мне хотелось бы открыть мою первую серию статей " джентельменский набор php программиста". как и во всей ..."><meta name=keywords content="captcha,OCR,online,PHP,защита интернет-ресурсов,интернет,класс,код,кодинг,ООП"><meta name=author content="Иван Блинков"><meta property=og:site_name content="Insight IT"><meta property=og:locale content=ru_RU><link href=https://www.insight-it.ru/feed/index.xml type=application/rss+xml rel=alternate title="Insight IT RSS Feed"></head><body><header><div class=container><a href=# data-activates=nav-mobile class="button-collapse top-nav waves-effect waves-light circle"><i class=icon-menu></i></a></div><ul id=nav-mobile class="side-nav fixed"><li class=logo><a id=logo-container href=https://www.insight-it.ru/ class=brand-logo><h4>Insight IT</h4></a></li><li class=bold><a href=https://www.insight-it.ru/highload/ > Высокие нагрузки </a></li><li class=bold><a href=https://www.insight-it.ru/interactive/ > Интерактивные сайты </a></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Рубрики </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a href=https://www.insight-it.ru/category/index/ > Все рубрики </a></li></ul></div></li></ul></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Страницы </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/blog/ > Блог </a></li><li><a href=https://www.insight-it.ru/about/ > О сайте </a></li><li><a href=https://www.insight-it.ru/author/ > Об авторе </a></li><li><a href=https://www.insight-it.ru/consulting/ > Консультации </a></li><li><a href=https://www.insight-it.ru/contact/ > Контакты </a></li><li><a href=https://www.insight-it.ru/resume/ > Резюме </a></li><li><a href=https://www.insight-it.ru/search/ > Поиск по сайту </a></li></ul></div></li></ul></li></ul></header><main><nav class=top-nav><div class=container><div class=nav-wrapper><ul id=nav-mobile class="right hide-on-med-and-down"><li class><a href=/blog/ >Блог</a></li><li class><a href=/about/ >О&nbsp;сайте</a></li><li class><a href=/author/ >Об&nbsp;авторе</a></li></ul><h1><a class=page-title> Защита интернет-ресурсов в картинках </a></h1></div></div></nav><div class=container><div class=row><div class="col s12 m9 l10"><div class="materialdesign section scrollspy"><section id=content class=body><article class=entry-content><p>Этой статьей мне хотелось бы открыть мою первую <a href=https://www.insight-it.ru/dzhentelmenskij-nabor-php-programmista/ >серию статей "Джентельменский набор PHP программиста"</a>. Как и во всей остальной серии здесь пойдет речь о программировании на PHP для интернет-проектов, но в каждой статье я буду выбирать один узкий аспект и на протяжении всей статьи буду стараться показать возможные варианты его реализации и применения.</p><p>Сегодня таким аспектом станет защита интернет-ресурса от возможного возникновения нежелательного контента со стороны пользователей с помощью технологии captcha (точнее о "графическом" варианте ее реализации), о которой уже <a href=https://www.insight-it.ru/security/2008/otkuda-voznikaet-spam-i-kak-s-nim-borotsya/ >неоднократно шла речь</a>.</p><p>Начать имеет смысл с небольшого напоминания о принципе работы этой технологии: перед потенциальным посетителем ставится некое препятствие, которое ему необходимо преодолеть для продолжения работы с интернет-ресурсом. Существует множество <a href=https://www.insight-it.ru/security/2008/7-sposobov-zashhitit-svoj-internet-resurs-ot-nezhelatelnoj-informacii/ >вариантов такого рода препятствий</a>. Как уже упоминалось, сегодня мы будем реализовывать только один наиболее распространенный тип - "графический". В простейшем случае он представляет собой просьбу переписать с изображения некий набор символов. В процессе генерирования изображения, символы сильно искажаются с целью предотвращения возможности их распознавания любой программой с помощью технологии OCR.</p><h3 id=podgotovka>Подготовка</h3><p>Прежде чем начать писать код стоит более детально осознать какая же цель перед нами стоит: нам необходимо написать скрипт, генерирующий искаженное изображение некоторого набора символов и незаметно для пользователя передающее этот набор какому-либо другому скрипту, который нас пока мало интересует, но ясно лишь, что собственно проверкой будет заниматься именно он на основе данных полученных от пользователя и нашего скрипта. Способов исказить текст существует огромное количество, в ходе написания статьи постараюсь упомянуть несколько самых эффективных и широкоиспользуемых из них.</p><p>В первую очередь стоит подготовить некий каркас кода, который мы будем впоследствии заполнять. Он будет состоять из двух частей:</p><ol><li>Описание класса, генерирующего изображение</li><li>Файл, который будет вызываться browser'ом. В нем будет подключено описание нашего класса, выбор настроек данного конкретного изображения и выполнено создание объекта класса, в соответствии с выбранными настройками.</li></ol><p>Для начала давайте определимся со списком параметров, которые будет иметь наш класс. Во-первых, нужно решить какой текст будет генерироваться, самый простой и распространенный вариант - просто четыре цифры, я в примере на нем и остановлюсь, а реально же можно использовать абсолютно любые приходящие в голову варианты. Во-вторых, размеры изображения и текста - их лучше подобрать фиксированными так, чтобы было максимально читабельно, при минимальных размерах изображения, но при желании можно сделать и возможность изменения их извне. Последним в списке параметров будет цвет фона и текста - их как раз лучше задавать вне класса, так как основным действием, необходимым при переносе этого скрипта с одного сайт на другой - подбор используемых цветов таким образом, чтобы изображение смотрелось не очень ужасно при текущем варианте дизайна, изменения в других параметрах требуются на порядок реже.</p><p>Итак, создание объекта будем производить максимально простым способом, параметрами укажем белый и черный цвета. Заготовка для самого класса будет выглядеть примерно следующим образом (предположим, что он хранится в файле <em>captcha.class.php</em>):</p><div class=highlight><pre><span class=cp>&lt;?php</span>
<span class=k>class</span> <span class=nc>Captcha</span>
<span class=p>{</span>
   <span class=k>private</span> <span class=nv>$string</span><span class=p>;</span> <span class=c1>// генерируемый текст</span>
   <span class=k>private</span> <span class=nv>$bgcol</span><span class=p>;</span>  <span class=c1>// основной цвет фона</span>
   <span class=k>private</span> <span class=nv>$fgcol</span><span class=p>;</span>  <span class=c1>// основной цвет текста</span>
   <span class=k>private</span> <span class=nv>$height</span><span class=p>;</span> <span class=c1>// высота изображения</span>
   <span class=k>private</span> <span class=nv>$width</span><span class=p>;</span>  <span class=c1>// ширина изображения</span>
   <span class=k>function</span> <span class=nf>__construct</span><span class=p>(</span><span class=nv>$bgcol</span><span class=p>,</span><span class=nv>$fgcol</span><span class=p>)</span>  <span class=c1>// конструктор, вызывается при создании экземпляра класса</span>
   <span class=p>{</span>
   <span class=p>}</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div><h3 id=zadaem-parametry>Задаем параметры</h3><p>Первым делом при создании объекта необходимо задать остальные параметры, размеры изображения можно указать прямо в конструкторе, а для генерации текста лучше написать отдельную функцию:</p><div class=highlight><pre><span class=cp>&lt;?php</span>
<span class=k>private</span> <span class=k>function</span> <span class=nf>generateImage</span><span class=p>()</span>  <span class=c1>// генерация изображения</span>
<span class=p>{</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=o>=</span><span class=mi>250</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>=</span><span class=mi>80</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=o>=</span><span class=nv>$fgcol</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=o>=</span><span class=nv>$bgcol</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>generateSymbols</span><span class=p>();</span>
 <span class=p>}</span>
 <span class=k>private</span> <span class=k>function</span> <span class=nf>generateSymbols</span><span class=p>()</span>   <span class=c1>// генерация четырех цифр</span>
 <span class=p>{</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=o>=</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>leadingZero</span><span class=p>(</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>10000</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
 <span class=p>}</span>
 <span class=k>private</span> <span class=k>function</span> <span class=nf>leadingZero</span><span class=p>(</span><span class=nv>$num</span><span class=p>,</span><span class=nv>$length</span><span class=p>)</span> <span class=c1>// дополнения числа num лидирующими нулями</span>
 <span class=p>{</span>                        <span class=c1>// до длины length</span>
  <span class=nv>$str</span><span class=o>=</span><span class=nb>strrev</span><span class=p>(</span><span class=nv>$num</span><span class=p>);</span>
  <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=nb>strlen</span><span class=p>(</span><span class=nv>$str</span><span class=p>);</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$length</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span><span class=nv>$str</span><span class=o>.=</span><span class=s2>"0"</span><span class=p>;</span>
  <span class=k>return</span> <span class=nb>strrev</span><span class=p>(</span><span class=nv>$str</span><span class=p>);</span>
 <span class=p>}</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div><p>Этих данных нам должно хватить для написания функции, генерирующей изображение.</p><h3 id=generiruem-izobrazhenie>Генерируем изображение</h3><p>Если забыть, что текст необходимо искажать, то функция, генерирующая изображение выглядела бы просто как:</p><div class=highlight><pre><span class=cp>&lt;?php</span>
<span class=k>private</span> <span class=k>function</span> <span class=nf>generateImage</span><span class=p>()</span>  <span class=c1>// генерация изображения</span>
<span class=p>{</span>
   <span class=nv>$im</span><span class=o>=@</span><span class=nb>imagecreatetruecolor</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>);</span>
   <span class=nv>$bcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
   <span class=nv>$fcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
   <span class=nb>imagefill</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nv>$bcol</span><span class=p>);</span>
   <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>40</span><span class=p>,</span><span class=mi>10</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>25</span><span class=p>,</span><span class=nv>$fcol</span><span class=p>,</span><span class=s2>"./font/font_name.ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>));</span>
   <span class=nb>header</span><span class=p>(</span><span class=s1>'Content-Type: image/png'</span><span class=p>);</span>
   <span class=nb>imagepng</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
   <span class=nb>imagedestroy</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div><div class="card yellow lighten-4"><div class=card-content> В данном методе используются функции модуля PHP под названием GD, основывающегося на одноименной библиотеке, убедитесь, что на Вашем хостинге этот модуль установлен. </div></div><p>Реально же ей пользоваться не стоит - такое изображение с легкостью поддается OCR. Полученный текст необходимо тем или иным образом исказить. Для вывода изображения используется формат PNG, но никто не мешает воспользоваться JPEG или GIF, для этого достаточно заменить везде png на название соответствующего формата.</p><h3 id=iskazhaem-tekst>Искажаем текст</h3><p>Вот списочек тех, способов искажения текста, которыми я буду пользоваться в примере, пользоваться всеми сразу естественно никто не заставляет, да и включив воображение можно придумать много модификаций приведенных мной способов или абсолютно других:</p><ul><li><em>использование нестандартных шрифтов</em> - функция imagettftext позволяет использовать произвольный шрифт в формате Truetype, чем и необходимо воспользоваться. В Сети можно найти огромное количество бесплатных шрифтов в этом формате. По возможности стоит выбирать шрифты, максимально не похожие на любой стандартный, но при этом легко читающиеся.</li><li><em>использование нескольких шрифтов</em> - сделав подборку подходящих шрифтов, можно не останавливаться на каком-то одном, а сделать выбор текущего шрифта случайным из списка.</li><li><em>случайный выбор цветов</em> - усложняет работу OCR и в большинстве случаев не сильно мешает восприятию человеком.</li><li><em>случайное расположение символов</em> - еще один способ усложнить работу программам, пытающимся прочитать текст.</li><li><em>неравномерный фон</em> - изобразив на фоне какой-либо абстрактный набор любых фигур, можно заставить программу-посетителя подумать что какая-то часть из них является символом. Например, пересечение двух прямых линий часто распознается как буква T или L. Неплохим вариантом является написание на фоне других символов другим цветом, сильно отличающимся от основного и близким к цвету фона.</li></ul><p>Для начала этого вполне хватит, перейдем к реализации, в комментариях постараюсь указывать все особенности:</p><div class=highlight><pre><span class=cp>&lt;?php</span>
<span class=k>private</span> <span class=k>function</span> <span class=nf>generateImage</span><span class=p>()</span> <span class=c1>// генерация изображения</span>
<span class=p>{</span>
   <span class=nv>$im</span><span class=o>=@</span><span class=nb>imagecreatetruecolor</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>);</span>  <span class=c1>// создаем пустое изображение</span>
   <span class=nv>$mcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>+</span><span class=mi>80</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>30</span><span class=o>+</span><span class=mi>150</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>55</span><span class=p>);</span> <span class=c1>// выбираем случайным образом</span>
   <span class=nv>$kcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>+</span><span class=mi>80</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>30</span><span class=o>+</span><span class=mi>150</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span> <span class=c1>// несколько цветов</span>
   <span class=nv>$lcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span>
   <span class=nv>$bcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
   <span class=nv>$fcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
   <span class=nb>imagefill</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nv>$bcol</span><span class=p>);</span>  <span class=c1>// заполняем изображение фоном</span>
   <span class=nv>$array</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>25</span><span class=p>,</span><span class=mi>26</span><span class=p>,</span><span class=mi>31</span><span class=p>,</span><span class=mi>32</span><span class=p>,</span><span class=mi>37</span><span class=p>,</span><span class=mi>39</span><span class=p>,</span><span class=mi>41</span><span class=p>);</span> <span class=c1>// список названий подходящих шрифтов</span>
   <span class=nv>$n</span><span class=o>=</span><span class=nv>$array</span><span class=p>[</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nb>count</span><span class=p>(</span><span class=nv>$array</span><span class=p>)];</span>  <span class=c1>// наугад выбираем из них один</span>
   <span class=nv>$m</span><span class=o>=</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
   <span class=nv>$k</span><span class=o>=</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$m</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$lcol</span><span class=p>);</span> <span class=c1>// создаем на фоне несколько линий</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$lcol</span><span class=p>);</span> <span class=c1>// и еще несколько</span>
   <span class=cm>/*</span>
<span class=cm>   Генерируем текст: две строки на фон, а также интересующие нас символы по одному.</span>
<span class=cm>   */</span>
   <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=o>+</span><span class=mi>40</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>-</span><span class=mi>50</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.8</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>25</span><span class=p>,</span><span class=nv>$kcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$k</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>randomString</span><span class=p>(</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>15</span><span class=p>));</span>
   <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>40</span><span class=o>+</span><span class=mi>35</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>70</span><span class=o>-</span><span class=mi>35</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.8</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>25</span><span class=o>+</span><span class=mi>25</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$m</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>randomString</span><span class=p>(</span><span class=mi>5</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>4</span><span class=p>));</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$istring</span><span class=p>);</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>10</span><span class=o>+</span><span class=mi>33</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>70</span><span class=o>-</span><span class=mi>35</span><span class=p>,</span><span class=mi>15</span><span class=o>+</span><span class=nv>$i</span><span class=o>*</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=o>/</span><span class=mi>5</span><span class=o>*</span><span class=mf>1.1</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>5</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>7</span><span class=o>+</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.73</span><span class=p>,</span><span class=nv>$fcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$n</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>[</span><span class=nv>$i</span><span class=p>]);</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$m</span><span class=o>/</span><span class=mi>10</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>);</span> <span class=c1>// еще линии</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=o>/</span><span class=mi>4</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>);</span>  <span class=c1>// и еще немного</span>
   <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=o>/</span><span class=mi>6</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
   <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$fcol</span><span class=p>);</span>  <span class=c1>// и еще чуть-чуть</span>
   <span class=nb>header</span><span class=p>(</span><span class=s1>'Content-Type: image/png'</span><span class=p>);</span>
   <span class=nb>imagepng</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
   <span class=nb>imagedestroy</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>private</span> <span class=k>function</span> <span class=nf>randomString</span><span class=p>(</span><span class=nv>$length</span><span class=p>)</span>  <span class=c1>// генерируем случайный набор символов заданной длины</span>
<span class=p>{</span>
  <span class=nv>$list</span><span class=o>=</span><span class=s2>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVXYZ!@#$%^&amp;**()-=_+.,&lt;&gt;/\|;:"</span><span class=p>;</span>
  <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=nv>$str</span><span class=o>=</span><span class=s2>""</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$length</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span><span class=nv>$str</span><span class=o>.=</span><span class=nb>substr</span><span class=p>(</span><span class=nv>$list</span><span class=p>,</span><span class=nb>mt_rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>strlen</span><span class=p>(</span><span class=nv>$list</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>),</span><span class=mi>1</span><span class=p>);</span>
  <span class=k>return</span> <span class=nv>$str</span><span class=p>;</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div><p>Стоит заметить, что конкретные цифры необходимо подбирать индивидуально, в примере они указаны абсолютно произвольно. Использование конкретно этих же цифр приведет к далеко не самым лучшим результатам.</p><h3 id=sborka>Сборка</h3><p>Не стоит забывать, что помимо генерации самого изображения, необходимо передать написанный текст другому скрипту, который будет сверять данные. Удобнее всего это делать через глобальный массив <code>$_SESSION</code>.</p><p>Собрав все написанное выше, и учтя передачу текста, можно получить следующий класс:</p><div class=highlight><pre><span class=cp>&lt;?php</span>
<span class=k>class</span> <span class=nc>Captcha</span>
<span class=p>{</span>
   <span class=k>private</span> <span class=nv>$string</span><span class=p>;</span> <span class=c1>// генерируемый текст</span>
   <span class=k>private</span> <span class=nv>$bgcol</span><span class=p>;</span>  <span class=c1>// основной цвет фона</span>
   <span class=k>private</span> <span class=nv>$fgcol</span><span class=p>;</span>  <span class=c1>// основной цвет текста</span>
   <span class=k>private</span> <span class=nv>$height</span><span class=p>;</span> <span class=c1>// высота изображения</span>
   <span class=k>private</span> <span class=nv>$width</span><span class=p>;</span>  <span class=c1>// ширина изображения</span>
   <span class=k>function</span> <span class=nf>__construct</span><span class=p>(</span><span class=nv>$bgcol</span><span class=p>,</span><span class=nv>$fgcol</span><span class=p>)</span>  <span class=c1>// конструктор, вызывается при создании экземпляра класса</span>
   <span class=p>{</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=o>=</span><span class=mi>250</span><span class=p>;</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>=</span><span class=mi>80</span><span class=p>;</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=o>=</span><span class=nv>$fgcol</span><span class=p>;</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=o>=</span><span class=nv>$bgcol</span><span class=p>;</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>generateSymbols</span><span class=p>();</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>generateImage</span><span class=p>();</span>
   <span class=p>}</span>
   <span class=k>private</span> <span class=k>function</span> <span class=nf>generateImage</span><span class=p>()</span> <span class=c1>// генерация изображения</span>
   <span class=p>{</span>
      <span class=nv>$im</span><span class=o>=@</span><span class=nb>imagecreatetruecolor</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>);</span>  <span class=c1>// создаем пустое изображение</span>
      <span class=nv>$mcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>+</span><span class=mi>80</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>30</span><span class=o>+</span><span class=mi>150</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>55</span><span class=p>);</span> <span class=c1>// выбираем случайным образом</span>
      <span class=nv>$kcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>+</span><span class=mi>80</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>30</span><span class=o>+</span><span class=mi>150</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span> <span class=c1>// несколько цветов</span>
      <span class=nv>$lcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span>
      <span class=nv>$bcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>bgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
      <span class=nv>$fcol</span><span class=o>=</span><span class=nb>imagecolorallocate</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fgcol</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
      <span class=nb>imagefill</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nv>$bcol</span><span class=p>);</span>  <span class=c1>// заполняем изображение фоном</span>
      <span class=nv>$array</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>25</span><span class=p>,</span><span class=mi>26</span><span class=p>,</span><span class=mi>31</span><span class=p>,</span><span class=mi>32</span><span class=p>,</span><span class=mi>37</span><span class=p>,</span><span class=mi>39</span><span class=p>,</span><span class=mi>41</span><span class=p>);</span> <span class=c1>// список названий подходящих шрифтов</span>
      <span class=nv>$n</span><span class=o>=</span><span class=nv>$array</span><span class=p>[</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nb>count</span><span class=p>(</span><span class=nv>$array</span><span class=p>)];</span>  <span class=c1>// наугад выбираем из них один</span>
      <span class=nv>$m</span><span class=o>=</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
      <span class=nv>$k</span><span class=o>=</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$m</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$lcol</span><span class=p>);</span> <span class=c1>// создаем на фоне несколько линий</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$lcol</span><span class=p>);</span> <span class=c1>// и еще несколько</span>
      <span class=cm>/*</span>
<span class=cm>      Генерируем текст: две строки на фон, а также интересующие нас символы по одному.</span>
<span class=cm>      */</span>
      <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>20</span><span class=o>+</span><span class=mi>40</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>100</span><span class=o>-</span><span class=mi>50</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.8</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>50</span><span class=o>+</span><span class=mi>25</span><span class=p>,</span><span class=nv>$kcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$k</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>randomString</span><span class=p>(</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>15</span><span class=p>));</span>
      <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>40</span><span class=o>+</span><span class=mi>35</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>70</span><span class=o>-</span><span class=mi>35</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.8</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>25</span><span class=o>+</span><span class=mi>25</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$m</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>randomString</span><span class=p>(</span><span class=mi>5</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>4</span><span class=p>));</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$istring</span><span class=p>);</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imagettftext</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>10</span><span class=o>+</span><span class=mi>33</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>70</span><span class=o>-</span><span class=mi>35</span><span class=p>,</span><span class=mi>15</span><span class=o>+</span><span class=nv>$i</span><span class=o>*</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=o>/</span><span class=mi>5</span><span class=o>*</span><span class=mf>1.1</span><span class=o>+</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>5</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>7</span><span class=o>+</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=o>*</span><span class=mf>0.73</span><span class=p>,</span><span class=nv>$fcol</span><span class=p>,</span><span class=s2>"./font/"</span><span class=o>.</span><span class=nv>$n</span><span class=o>.</span><span class=s2>".ttf"</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>[</span><span class=nv>$i</span><span class=p>]);</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$m</span><span class=o>/</span><span class=mi>10</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>);</span> <span class=c1>// еще линии</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=o>/</span><span class=mi>4</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$mcol</span><span class=p>);</span>  <span class=c1>// и еще немного</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$k</span><span class=o>/</span><span class=mi>6</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span>
      <span class=nb>imageline</span><span class=p>(</span><span class=nv>$im</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>width</span><span class=p>,</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>height</span><span class=p>,</span><span class=nv>$fcol</span><span class=p>);</span>  <span class=c1>// и еще чуть-чуть</span>
      <span class=nb>header</span><span class=p>(</span><span class=s1>'Content-Type: image/png'</span><span class=p>);</span>
      <span class=nb>imagepng</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
      <span class=nb>imagedestroy</span><span class=p>(</span><span class=nv>$im</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=k>private</span> <span class=k>function</span> <span class=nf>generateSymbols</span><span class=p>()</span>   <span class=c1>// генерация четырех цифр</span>
   <span class=p>{</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=o>=</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>leadingZero</span><span class=p>(</span><span class=nb>rand</span><span class=p>()</span><span class=o>%</span><span class=mi>10000</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=k>private</span> <span class=k>function</span> <span class=nf>leadingZero</span><span class=p>(</span><span class=nv>$num</span><span class=p>,</span><span class=nv>$length</span><span class=p>)</span> <span class=c1>// дополнения числа num лидирующими нулями</span>
   <span class=p>{</span>                        <span class=c1>// до длины length</span>
      <span class=nv>$str</span><span class=o>=</span><span class=nb>strrev</span><span class=p>(</span><span class=nv>$num</span><span class=p>);</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=nb>strlen</span><span class=p>(</span><span class=nv>$str</span><span class=p>);</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$length</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span><span class=nv>$str</span><span class=o>.=</span><span class=s2>"0"</span><span class=p>;</span>
      <span class=k>return</span> <span class=nb>strrev</span><span class=p>(</span><span class=nv>$str</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=k>private</span> <span class=k>function</span> <span class=nf>randomString</span><span class=p>(</span><span class=nv>$length</span><span class=p>)</span>  <span class=c1>// генерируем случайный набор символов заданной длины</span>
   <span class=p>{</span>
      <span class=nv>$list</span><span class=o>=</span><span class=s2>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVXYZ!@#$%^&amp;**()-=_+.,&lt;&gt;/\|;:"</span><span class=p>;</span>
      <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=nv>$str</span><span class=o>=</span><span class=s2>""</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$length</span><span class=p>;</span><span class=o>++</span><span class=nv>$i</span><span class=p>)</span><span class=nv>$str</span><span class=o>.=</span><span class=nb>substr</span><span class=p>(</span><span class=nv>$list</span><span class=p>,</span><span class=nb>mt_rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>strlen</span><span class=p>(</span><span class=nv>$list</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>),</span><span class=mi>1</span><span class=p>);</span>
      <span class=k>return</span> <span class=nv>$str</span><span class=p>;</span>
   <span class=p>}</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div><p>Слегка доработав его и приведя в более подходящий вид, можно добиться генерации изображений, выглядящих например вот так:</p><p><img alt="CAPTCHA Sample" class=responsive-img src=https://www.insight-it.ru/images/captcha-sample.png title="Пример получающегося изображения"></p><p>Специально не выкладываю уже доведенный до ума класс, чтобы у читателей не возникало желания просто взять и воспользоваться им, это приведет лишь к очередной серии captcha-клонов.</p><div class=sharrre-wrapper><div class=twitter data-url=https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/ data-text="Защита интернет-ресурсов в картинках" data-title=Tweet></div><div class=facebook data-url=https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/ data-text="Защита интернет-ресурсов в картинках" data-title=Like></div><div class=linkedin data-url=https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/ data-text="Защита интернет-ресурсов в картинках" data-title="In Share" ></div></div><div class="card-panel light-blue darken-2 light-blue-text text-lighten-4"><span class=published title=2008-01-13T22:30:00+03:00>13 января 2008</span>&nbsp;|&nbsp;<span class="vcard author"><a class="url fn light-blue-text text-lighten-4" href=https://www.insight-it.ru/author/ > Иван Блинков </a></span>&nbsp;|&nbsp;<a href=https://www.insight-it.ru/category/php/ class="light-blue-text text-lighten-4" > PHP </a></div><div class=taglist class=row><a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/captcha/ > captcha </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/ocr/ > OCR </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/online/ > online </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/php/ > PHP </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/zashchita-internet-resursov/ > защита интернет-ресурсов </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/internet/ > интернет </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/klass/ > класс </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/kod/ > код </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/koding/ > кодинг </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/oop/ > ООП </a>&ensp;</div></footer></article></section></div><div class=after><div id=comments></div><script type=text/javascript>
        var disqus_shortname = 'insight-it';
        var disqus_identifier = '23 http://www.insight-it.ru/programming/php/zashhita-internet-resursov-v-kartinkax/';
        var disqus_url = 'https://www.insight-it.ru/php/2008/zashhita-internet-resursov-v-kartinkax/';
        var disqus_domain = 'disqus.com';
        var disqus_title = 'Защита интернет-ресурсов в картинках';
        var disqus_container_id = 'comments';
        (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//insight-it.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script></div></div><div class="col hide-on-small-only m3 l2"><div class=card><a href=https://www.insight-it.ru/author><div class="card-image tooltipped" data-position=top data-delay=50 data-tooltip="Автор Insight IT"><img src=https://www.insight-it.ru/images/avatar.jpeg><span class=card-title>Иван Блинков</span></div></a></div><div class=toc-wrapper><div style="height: 1px;"><ul class="section table-of-contents"><li><a href=# title="Защита интернет-ресурсов в картинках">Защита интернет-ресурсов в картинках</a><li><a href=#podgotovka title=Подготовка>Подготовка</a></li><li><a href=#zadaem-parametry title="Задаем параметры">Задаем параметры</a></li><li><a href=#generiruem-izobrazhenie title="Генерируем изображение">Генерируем изображение</a></li><li><a href=#iskazhaem-tekst title="Искажаем текст">Искажаем текст</a></li><li><a href=#sborka title=Сборка>Сборка</a></li></li></ul></div></div></div></div></div></main><footer class=page-footer><div id=footer class=container><div class=row><div class="col m4 s12"><h5 class=white-text>Иван Блинков</h5><ul><li><a href=mailto:insight-it@blinkov.ru rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-mail white-text"></i> insight-it@blinkov.ru </span></a></li><li><a href=https://www.linkedin.com/in/ivanblinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-linkedin light-blue-text text-darken-3"></i> LinkedIn </span></a></li><li><a href=https://twitter.com/blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-twitter cyan-text text-accent-2"></i> @blinkov </span></a></li><li><a href="http://plus.google.com/102882395551389724078?rel=author" rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-gplus red-text"></i> Google </span></a></li><li><a href=https://www.facebook.com/ivan.blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-facebook blue-text text-darken-3"></i> Facebook </span></a></li><li><a href=https://www.insight-it.ru/feed/ rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-rss orange-text"></i> Подписаться по RSS </span></a></li></ul><a href=//feeds.feedburner.com/insight-it/feed target=_blank rel="external nofollow"><img src="//feeds.feedburner.com/~fc/insight-it/feed?bg=b3e5fc&amp;fg=222222&amp;anim=1" height=26 width=88></a>&nbsp;<a href=//twitter.com/blinkov target=_blank rel="external nofollow"><img src=//button.twittercounter.com/animated/blinkov/222222/b3e5fc width=88 height=26></a></div><div class="col m4 s12"><h5 class=white-text>Рубрики</h5><ul><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/highload/ > Высокие нагрузки </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/interactive/ > Интерактивные сайты </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/php/ > PHP </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/security/ > Безопасность </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/vacancy/ > Вакансии </a></li></ul><h5 class=white-text>Навигация</h5><ul><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/blog/ >Блог</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/about/ >О&nbsp;сайте</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/author/ >Об&nbsp;авторе</a></li></ul></div><div class="col m4 s12"><h5 class="white-text center-align">Теги</h5><div class="tagcloud taglist"><span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/arkhitektura/ > архитектура </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/mysql/ > MySQL </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/javascript/ > JavaScript </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/highload/ > highload </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hbase/ > HBase </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/razrabotka/ > разработка </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/informatsionnye-tekhnologii/ > информационные технологии </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/facebook/ > Facebook </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hadoop/ > Hadoop </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/java/ > Java </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/c/ > C++ </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/memcached/ > Memcached </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/apache/ > Apache </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/oop/ > ООП </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/programmirovanie/ > Программирование </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/linux/ > Linux </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/meropriiatiia/ > мероприятия </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/google/ > Google </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/php/ > PHP </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/tekhnologiia/ > технология </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/internet/ > интернет </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/online/ > online </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/python/ > Python </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/masshtabiruemost/ > Масштабируемость </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/nginx/ > nginx </a></span>&ensp;</div></div></div></div><div class=footer-copyright><div class=container> © Insight IT, 2008-2015 <a class="license right tooltipped" rel="license nofollow" target=_blank href=http://creativecommons.org/licenses/by-nc-nd/4.0/ data-position=left data-delay=50 data-tooltip="Все материалы опубликованы под лицензией Creative Commons Attribution-NonCommercial-NoDerivatives 4.0"><img alt="Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License" src=https://www.insight-it.ru/theme/images/license.png></a></div></div></footer><script src=//code.jquery.com/jquery-2.1.1.min.js></script><script src=https://www.insight-it.ru/theme/js/main.js?b5bb290d></script><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js ','ga');
ga('create', 'UA-3403373-1', 'auto');
ga('send', 'pageview');
</script></body></html>