<!DOCTYPE html>
<html lang=ru xmlns=http://www.w3.org/1999/xhtml xmlns:og=http://ogp.me/ns# xmlns:fb=https://www.facebook.com/2008/fbml><head><meta http-equiv=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=msapplication-tap-highlight content=no><title>Архитектура Twitter. Два года спустя.</title><link href="//fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=PT+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link rel=stylesheet href=https://www.insight-it.ru/theme/css/main.css?5e55de6b><link rel=canonical href=https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/ ><meta property=og:url content=https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/ ><meta property=og:title content="Архитектура Twitter. Два года спустя."><meta property=og:type content=article><meta name=description content="В далеком 2008м я уже публиковал статью про архитектуру Twitter, но время летит стремительно и она уже абсолютно ..."><meta property=og:description content="В далеком 2008м я уже публиковал статью про архитектуру Twitter, но время летит стремительно и она уже абсолютно ..."><meta name=keywords content="Apache,Cassandra,featured,Flock,FlockDB,Hadoop,HBase,Kestrel,Memcached,MySQL,Pig,Ruby,Ruby on Rails,Scala,Scribe,Twitter,Unicorn,архитектура Twitter,интернет-проекты,Масштабируемость,социальная сеть"><meta property=og:image content=https://www.insight-it.ru/images/twitter-teaser.png><meta name=author content="Иван Блинков"><meta property=og:site_name content="Insight IT"><meta property=og:locale content=ru_RU><link href=https://www.insight-it.ru/feed/index.xml type=application/rss+xml rel=alternate title="Insight IT RSS Feed"></head><body><header><div class=container><a href=# data-activates=nav-mobile class="button-collapse top-nav waves-effect waves-light circle"><i class=icon-menu></i></a></div><ul id=nav-mobile class="side-nav fixed"><li class=logo><a id=logo-container href=https://www.insight-it.ru/ class=brand-logo><h4>Insight IT</h4></a></li><li class=bold><a href=https://www.insight-it.ru/highload/ > Высокие нагрузки </a></li><li class=bold><a href=https://www.insight-it.ru/interactive/ > Интерактивные сайты </a></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Рубрики </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a href=https://www.insight-it.ru/category/index/ > Все рубрики </a></li></ul></div></li></ul></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Страницы </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/blog/ > Блог </a></li><li><a href=https://www.insight-it.ru/about/ > О сайте </a></li><li><a href=https://www.insight-it.ru/author/ > Об авторе </a></li><li><a href=https://www.insight-it.ru/consulting/ > Консультации </a></li><li><a href=https://www.insight-it.ru/contact/ > Контакты </a></li><li><a href=https://www.insight-it.ru/resume/ > Резюме </a></li><li><a href=https://www.insight-it.ru/search/ > Поиск по сайту </a></li></ul></div></li></ul></li></ul></header><main><nav class=top-nav><div class=container><div class=nav-wrapper><ul id=nav-mobile class="right hide-on-med-and-down"><li class><a href=/blog/ >Блог</a></li><li class><a href=/about/ >О&nbsp;сайте</a></li><li class><a href=/author/ >Об&nbsp;авторе</a></li></ul><h1><a class=page-title> Архитектура Twitter. Два года спустя. </a></h1></div></div></nav><div class=container><div class=row><div class="col s12 m9 l10"><div class="materialdesign section scrollspy"><section id=content class=body><article class=entry-content><div class=card><div class=card-image><img src=https://www.insight-it.ru/images/twitter-teaser.png alt="Архитектура Twitter. Два года спустя." title="Архитектура Twitter. Два года спустя." class=responsive-img></div></div><p>В далеком 2008м я уже публиковал статью про <a href=https://www.insight-it.ru/highload/2008/arkhitektura-twitter/ >архитектуру Twitter</a>, но время летит стремительно и она уже абсолютно устарела. За это время аудитория Twitter росла просто фантастическими темпами и многое поменялось и с технической точки зрения. Интересно что новенького у одного из самых популярных социальных интернет-проектов?</p><h2 id=statistika>Статистика</h2><ul><li>3 год, 2 месяца и 1 день потребовалось Twitter, чтобы набрать 1 миллиард твитов</li><li>На сегодняшний день, чтобы отправить миллиард твитов пользователям нужна всего одна неделя</li><li>752% рост аудитории за 2008 год</li><li>1358% рост аудитории за 2009 год&nbsp;(без учета API, по данным comScore)</li><li>175 миллионов зарегистрированных пользователей на сентябрь 2010 года</li><li>460 тысяч регистраций пользователей в день</li><li>9й сайт в мире по популярности (по данным Alexa, год назад был на 12 месте)</li><li>50 миллионов твитов в день год назад, 140 миллионов твитов в день месяц назад, 177 миллионов твитов в день на 11 марта 2011г.</li><li>Рекорд по количеству твитов за секунду 6939, установлен через минуту после того, как Новый Год 2011 наступил в Японии</li><li>600 миллионов поисков в день</li><li>Лишь 25% трафика приходится на веб сайт, остальное идет через API</li><li>Росто числа мобильных пользователей за последний год 182%</li><li><strong>6 миллиардов</strong> запросов к API в день, около 70 тысяч в секунду</li><li>8, 29, 130, 350, 400 - это количество сотрудников Twitter на январь 2008, январь 2009, январь 2010, январь и март 2011, соответственно</li></ul><p>Самая свежая <a href=https://www.insight-it.ru/goto/682783c0/ rel=nofollow target=_blank title=http://blog.twitter.com/2011/03/numbers.html>статистика про Twitter</a>.</p><h2 id=platforma>Платформа</h2><ul><li><a href=/tag/apache/ >Apache</a> + <code>mod_proxy</code></li><li><a href=/tag/unicorn/ >Unicorn</a></li><li><a href=/tag/ruby/ >Ruby</a> +&nbsp;<a href=/tag/ror/ >Ruby on Rails</a></li><li><a href=/tag/scala/ >Scala</a></li><li><a href=/tag/flock/ >Flock</a></li><li><a href=/tag/memcached/ >memcached</a></li><li><a href=/tag/kestrel/ >Kestrel</a></li><li><a href=/tag/mysql/ >MySQL</a></li><li><a href=/tag/cassandra/ >Cassandra</a></li><li><a href=/tag/scribe/ >Scribe</a></li><li><a href=/tag/hadoop/ >Hadoop</a>, <a href=/tag/hbase/ >HBase</a> и <a href=/tag/pig/ >Pig</a></li></ul><p>Сравните с аналогичным разделом предыдущей статьи о Twitter - увидите много новых лиц, подробнее ниже.</p><h2 id=oborudovanie>Оборудование</h2><ul><li>Сервера расположены в NTT America</li><li>Никаких облаков и виртуализации, существующие решения страдают слишком высокими задержками</li><li>Более тысячи серверов</li><li>Планируется переезд в собственный датацентр</li></ul><h2 id=chto-takoe-tvit>Что такое твит?</h2><ul><li>Сообщение длиной до 140 символов + метаданные</li><li>Типичные запросы:<ul><li>по идентификатору</li><li>по автору</li><li>по @упоминаниям пользователей</li></ul></li></ul><h2 id=arkhitektura>Архитектура</h2><p><img alt="Процесс обработки запроса в Twitter" class=responsive-img src=https://www.insight-it.ru/images/twitter-request-flow.jpeg title="Процесс обработки запроса в Twitter"></p><h3 id=unicorn>Unicorn</h3><p>Сервер приложений для Rails:</p><ul><li>Развертывание новых версий кода <strong>без простоя</strong></li><li>На 30% меньше расход вычислительных ресурсов и оперативной памяти, по сравнению с другими решениями</li><li>Перешли с <code>mod_proxy_balancer</code> на <code>mod_proxy_pass</code></li></ul><h3 id=rails>Rails</h3><p>Используется в основном для генерации страниц, работа за сценой реализована на чистом Ruby или Scala.</p><p>Столкнулись со следующими проблемами:</p><ul><li>Проблемы с кэшированием, особенно по части инвалидации</li><li>ActiveRecord генерирует не самые удачные SQL-запросы, что замедляло время отклика</li><li>Высокие задержки в очереди и при репликации</li></ul><h3 id=memcached>memcached</h3><ul><li>memcached не идеален. Twitter начал сталкиваться с Segmentation Fault в нем очень рано.</li><li>Большинство стратегий кэширования основываются на длинных TTL (более минуты).</li><li>Вытеснение данных делает его непригодным для важных конфигурационных данных (например флагов "темного режима", о котором пойдет речь ниже).</li><li>Разбивается на несколько пулов для улучшения производительности и снижения риска вытеснения.</li><li>Оптимизированная библиотека для доступа к memcached из Ruby на основе libmemcached + FNV hash, вместо чистого Ruby и md5.</li><li>Twitter является одним их наиболее активных проектов, участвующих в разработке libmemcached.</li></ul><h3 id=mysql>MySQL</h3><ul><li>Разбиение больших объемов данных является тяжелой задачей.</li><li>Задержки в репликации и вытеснение данных из кэша является причиной нарушения целостности данных с точки зрения конечного пользователя.</li><li>Блокировки создают борьбу за ресурсы для популярных данных.</li><li>Репликация однопоточна и происходит недостаточно быстро.</li><li>Данные социальных сетей плохо подходят для реляционных СУБД:<ul><li>NxN отношения, социальный граф и обход деревьев - не самые подходящие задачи для таких баз данных</li><li>Проблемы с дисковой подсистемой (выбор файловой системы, noatime, алгоритм планирования)</li><li>ACID практически не требуется</li><li>Для очередей также практически непригодны</li></ul></li><li>Twitter сталкивался с большими проблемами касательно таблиц пользователей и их статусов</li><li>Читать данные с мастера при Master/Slave репликации = медленная смерть</li></ul><h3 id=flockdb>FlockDB</h3><p>Масштабируемое хранилище для данных социального графа:</p><ul><li>Разбиение данных через Gizzard</li><li>Множество серверов MySQL в качестве низлежащей системы хранения</li><li>В Twitter содержит 13 миллиардов ребер графа и обеспечивает 20 тысяч операций записи и 100 тысяч операций чтения в секунду</li><li>Грани хранятся и индексируются в обоих направлениях</li><li>Поддерживает распределенный подсчет количества строк</li><li><a href=https://www.insight-it.ru/goto/4fe0530b/ rel=nofollow target=_blank title=https://github.com/twitter/flockdb>Open source!</a></li></ul><p>Среднее время на выполнение операций:</p><ul><li>Подсчет количества строк: 1мс</li><li>Временные запросы: 2мс</li><li>Запись: 1мс для журнала, 16мс для надежной записи</li><li>Обход дерева: 100 граней/мс</li></ul><p>Подробнее про эволюцию систем хранения данных в Twitter <a href=https://www.insight-it.ru/goto/32077a90/ rel=nofollow target=_blank title=http://www.slideshare.net/nkallen/q-con-3770885>в презентации Nick Kallen</a>.</p><h3 id=cassandra>Cassandra</h3><p>Распределенная система хранения данных, ориентированная на работу в реальном времени:</p><ul><li>Изначально разработана в <a href=/tag/facebook/ >Facebook</a></li><li>Очень высокая производительность на запись</li><li>Из слабых сторон: высокая задержка при случайном доступе</li><li>Децентрализованная, способна переносить сбои оборудования</li><li>Гибкая схема данных</li><li><del>Планируется полный переход на нее по следующему алгоритму:</del><ul><li><del>Все твиты пишутся и в Cassandra и в MySQL</del></li><li><del>Динамически часть операций чтения переводится на Cassandra</del></li><li><del>Анализируется реакция системы, что сломалось</del></li><li><del>Полностью отключаем чтение из Cassandra, чиним неисправности</del></li><li><del>Начинаем сначала</del></li></ul></li><li><strong><a href=https://www.insight-it.ru/goto/e83e4e8e/ rel=nofollow target=_blank title=http://engineering.twitter.com/2010/07/cassandra-at-twitter-today.html>Обновление:</a></strong> стратегия по поводу использования Cassandra изменилась, попытки использовать её в роли основного хранилища для твитов прекратились, но она продолжает использоваться для аналитики и географической информации.</li></ul><p>Подробнее почему Twitter пришел к решению использовать Cassandra можно прочитать <a href=https://www.insight-it.ru/goto/ffc31d1/ rel=nofollow target=_blank title=http://www.slideshare.net/ryansking/scaling-twitter-with-cassandra>в отдельной презентации</a>.</p><p>Помимо всего прочего Cassandra&nbsp;<del>планируется использовать</del> используется для аналитики в реальном времени.</p><h3 id=scribe>Scribe</h3><p>Пользователи Twitter генерируют огромное количество данных, около 15-25 Гб в минуту, более 12 Тб в день, и эта цифра удваивается несколько раз в год.</p><p>Изначально для сбора логов использовали <code>syslog-ng</code>, но он очень быстро перестал справляться с нагрузкой.</p><p>Решение нашлось очень просто: <a href=/tag/facebook/ >Facebook</a> столкнулся с аналогичной проблемой и разработал проект Scribe, который был опубликован в opensource.</p><p>По сути это фреймворк для сбора и агрегации логов, основанный на <a href=/tag/thrift/ >Thrift</a>. Вы пишете текст для логов и указываете категорию, остальное он берет на себя.</p><p>Работает локально, надежен даже в случае потери сетевого соединения, каждый узел знает только на какой сервер передавать логи, что позволяет создавать масштабируемую иерархию для сбора логов.</p><p>Поддерживаются различные системы для записи в данным, &nbsp;в том числе обычные файлы и HDFS (о ней ниже).</p><p>Этот продукт полностью решил проблему Twitter со сбором логов, используется около 30 различных категорий. В процессе использования была создана и опубликована масса доработок. Активно сотрудничают с командой Facebook в развитии проекта.</p><h3 id=hadoop>Hadoop</h3><p>Как Вы обычно сохраняете 12Тб новых данных, поступающих каждый день?</p><p>Если считать, что средняя скорость записи современного жесткого диска составляет 80Мбайт в секунду, запись 12Тб данных заняла бы почти 48 часов.</p><p>На одном даже очень большом сервере данную задачу не решить, логичным решением задачи стало использование кластера для хранения и анализа таких объемов данных.</p><p>Использование кластерной файловой системы добавляет сложности, но позволяет меньше заботиться о деталях.</p><p>Hadoop Distributed File System (HDFS) предоставляет возможность автоматической репликации и помогает справляться со сбоями оборудования.</p><p>MapReduce framework позволяет обрабатывать огромные объемы данных, анализируя пары ключ-значение.</p><p>Типичные вычислительные задачи, которые решаются с помощью Hadoop в Twitter:</p><ul><li>Вычисление связей дружбы в социальном графе (<code>grep</code> и <code>awk</code> не справились бы, self join в MySQL на таблицах с миллиардами строк - тоже)</li><li>Подсчет статистики (количество пользователей и твитов, например подсчет количества твитов занимает 5 минут при 12 миллиардах записей)</li><li>Подсчет PageRank между пользователями для вычисления репутации.</li></ul><p>В твиттер используется бесплатный дистрибутив от Cloudera, версия Hadoop 0.20.1, данные храняться <a href=https://www.insight-it.ru/goto/1ac5bba3/ rel=nofollow target=_blank title=https://github.com/kevinweil/hadoop-lzo>в сжатом по алгоритму LZO виде</a>, библиотеки для работы с данными опубликованы под названием <a href=https://www.insight-it.ru/goto/a1b5430e/ rel=nofollow target=_blank title=https://github.com/kevinweil/elephant-bird>elephant-bird</a>.</p><h3 id=pig>Pig</h3><p>Для того чтобы анализировать данные с помощью MapReduce обычно необходимо разрабатывать код на Java, что далеко не все умеют делать, да и трудоемко это.</p><p>Pig представляет собой высокоуровневый язык, позволяющий трансформировать огромные наборы данных шаг за шагом.</p><p>Немного напоминает SQL, но намного проще. Это позволяет писать в 20 раз меньше кода, чем при анализе данных с помощью обычных MapReduce работ. Большая часть работы по анализу данных в Twitter осуществляется с помощью Pig.</p><h3 id=dannye>Данные</h3><p>Полу-структурированные данные:</p><ul><li>логи Apache, RoR, MySQL, A/B тестирования, процесса регистрации</li><li>поисковые запросы</li></ul><p>Структурированные данные:</p><ul><li>Твиты</li><li>Пользователи</li><li>Блок-листы</li><li>Номера телефонов</li><li>Любимые твиты</li><li>Сохраненные поиски</li><li>Ретвиты</li><li>Авторизации</li><li>Подписки</li><li>Сторонние клиенты</li><li>География</li></ul><p>Запутанные данные:</p><ul><li>Социальный граф</li></ul><p><strong>Что же они делают с этим всем?</strong></p><ul><li>Подсчет математического ожидания, минимума, максимума и дисперсии следующих показателей:<ul><li>Количество запросов за сутки</li><li>Средняя задержка, 95% задержка</li><li>Распределение кодов HTTP-ответов (по часам)</li><li>Количество поисков осуществляется каждый день</li><li>Количество уникальных запросов и пользователей</li><li>Географическое распределение запросов и пользователей</li></ul></li><li>Подсчет вероятности, ковариации, влияния:<ul><li>Как отличается использование через мобильные устройства?</li><li>Как влияет использование клиентов сторонних разработчиков?</li><li>Когортный анализ</li><li>Проблемы с сайтом (киты и роботы, подробнее ниже)</li><li>Какие функциональные возможности цепляют пользователей?</li><li>Какие функциональные возможности чаще используются популярными пользователями?</li><li>Корректировка и предложение поисковых запросов</li><li>A/B тестирование</li></ul></li><li>Предсказания, анализ графов, естественные языки:<ul><li>Анализ пользователей по их твитам, твитов, на которые они подписаны, твитам их фоловеров</li><li>Какая структура графа ведет к успешным популярным сетям</li><li>Пользовательская репутация</li><li>Анализ эмоциональной окраски</li><li>Какие особенности заставляют людей ретвитнуть твит?</li><li>Что влияет на глубину дерева ретвитов ?</li><li>Долгосрочное обнаружение дубликатов</li><li>Машинное обучение</li><li>Обнаружения языка</li></ul></li></ul><p>Подробнее про обработку данных <a href=https://www.insight-it.ru/goto/3d4649ef/ rel=nofollow target=_blank title=http://www.slideshare.net/kevinweil/nosql-at-twitter-nosql-eu-2010>в презентации Kevin Weil</a>.</p><h3 id=hbase>HBase</h3><p>Twitter начинают строить настоящие сервисы на основе Hadoop, например поиск людей:</p><ul><li>HBase используется как изменяемая прослойка над HDFS</li><li>Данные экспортируются из HBase c помощью периодической MapReduce работы:<ul><li>На этапе Map используются также данные из FlockDB и нескольких внутренних сервисов</li><li>Собственная схема разбиения данных</li><li>Данные подтягиваются через высокопроизводительный, горизонтально масштабируемый сервис на Scala (<a href=https://www.insight-it.ru/goto/917f8c95/ rel=nofollow target=_blank title=http://www.slideshare.net/al3x/building-distributed-systems-in-scala>подробнее о построении распределенных сервисов на Scala</a>)</li></ul></li></ul><p>На основе HBase разрабатываются и другие продукты внутри Twitter.</p><p>Основными её достоинствами являются гибкость и легкая интеграция с Hadoop и Pig.</p><p>По сравнению с Cassandra:</p><ul><li>"Их происхождение объясняет их сильные и слабые стороны"</li><li>HBase построен на основе системы по пакетной обработке данных, высокие задержки, работает далеко не в реальном времени</li><li>Cassandra построена с нуля для работы с низкими задержками</li><li>HBase легко использовать при анализе данных как источник или место сохранения результатов, Cassandra для этого подходит меньше, но они работают над этим</li><li>HBase на данный момент единственную точку отказа в виде мастер-узла</li><li>В твиттере HBase используется для аналитики, анализа и создания наборов данных, а Cassandra - для онлайн систем</li></ul><h3 id=loony>Loony</h3><p>Централизованная система управления оборудованием.</p><p>Реализована с использованием:</p><ul><li><a href=/tag/python/ >Python</a></li><li><a href=/tag/django/ >Django</a></li><li><a href=/tag/mysql/ >MySQL</a></li><li><a href=https://www.insight-it.ru/goto/8927633f/ rel=nofollow target=_blank title=http://www.lag.net/paramiko>Paraminko</a> (реализация протокола SSH на Python, разработана и опубликована в opensource в Twitter)</li></ul><p>Интегрирована с LDAP, анализирует входящую почту от датацентра и автоматически вносит изменения в базу.</p><h3 id=murder>Murder</h3><p>Система развертывания кода и ПО, основанная на протоколе BitTorrent.</p><p>Благодаря своей P2P природе позволяет обновить более тысячи серверов за 30-60 секунд.</p><h3 id=kestrel>Kestrel</h3><p>Распределенная очередь, работающая по протоколу memcache:</p><ul><li><code>set</code> - поставить в очередь</li><li><code>get</code> - взять из очереди</li></ul><p>Особенности:</p><ul><li>Отсутствие строгого порядка выполнения заданий</li><li>Отсутствие общего состояния между серверами</li><li>Разработана на <a href=/tag/scala/ >Scala</a></li></ul><h3 id=daemony>Daemon'ы</h3><p>Каждый твит обрабатывается с помощью daemon'ов.</p><p>В unicorn обрабатываются только HTTP запросы, вся работа за сценой реализована в виде отдельных daemon'ов.</p><p>Раньше использовалось много разных демонов, по одному на каждую задачу (Rails), но перешли к меньшему их количеству, способному решать несколько задач одновременно.</p><h3 id=kak-oni-spravliaiutsia-s-takimi-tempami-rosta>Как они справляются с такими темпами роста?</h3><p>Рецепт прост, но эффективен, подходит практически для любого интернет-проекта:</p><ul><li><em>обнаружить самое слабое место в системе;</em></li><li><em>принять меры по его устранению;</em></li><li><em>перейти к следующему самому слабому месту.</em></li></ul><p>На словах звучит и правда примитивно, но на практике нужно предпринять ряд мер, чтобы такой подход был бы реализуем:</p><ul><li>Автоматический сбор метрик (причем в агрегированном виде)</li><li>Построение графиков (RRD, Ganglia)</li><li>Сбор и анализ&nbsp;логов</li><li>Все данные должны получаться с минимальной задержкой, как можно более близко к реальному времени</li><li>Анализ:<ul><li>Из данных необходимо получать <em>информацию</em></li><li>Следить за динамикой показателей: стало лучше или хуже?</li><li>Особенно при развертывании новых версий кода</li><li>Планирование использования ресурсов намного проще, чем решение экстренных ситуаций, когда они на исходу</li></ul></li></ul><p>Примерами агрегированных метрик в Twitter являются "киты" и "роботы", вернее их количество в единицу времени.</p><h5>Что такое "робот"?</h5><p><img alt="Twitter Робот" class=responsive-img src=https://www.insight-it.ru/images/twitter-bot.jpg title="Twitter Робот"></p><ul><li>Ошибка внутри Rails (HTTP 500)</li><li>Непойманное исключение</li><li>Проблема в коде или нулевой результат</li></ul><h5>Что такое "кит"?</h5><p><img alt="Twitter Кит" class=responsive-img src=https://www.insight-it.ru/images/twitter-whale.jpg title="Twitter Кит"></p><ul><li>HTTP ошибка 502 или 503</li><li>В твиттер используется фиксированный таймаут в 5 секунд (лучше кому-то показать ошибку, чем захлебнуться в запросах)</li><li>Убитый слишком длинный запрос к базе данных (mkill)</li></ul><p>Значительное превышение нормального количества китов или роботов в минуту является поводом для беспокойством.</p><p>Реализован этот механизм простым bash-скриптом, который просматривает агрегированные логи за последние 60 секунд, подсчитывает количество китов/роботов и рассылает уведомления, если значение оказалось выше порогового значения. Подробнее про работу команды оперативного реагирования <a href=https://www.insight-it.ru/goto/30562be/ rel=nofollow target=_blank title=http://www.slideshare.net/netik/billions-of-hits-scaling-twitter>в презентации John Adams</a>.</p><h3 id=temnyi-rezhim>"Темный режим"</h3><p>Для экстренных ситуаций в Twitter предусмотрен так называемый "темный режим", который представляет собой набор механизмов для отключения тяжелых по вычислительным ресурсам или вводу-выводу функциональных частей сайта. Что-то вроде стоп-крана для сайта.</p><p>Имеется около 60 выключателей, в том числе и полный режим "только для чтения".</p><p>Все изменения в настройках этого режима фиксируются в логах и сообщаются руководству, чтобы никто не баловался.</p><h2 id=podvodim-itogi_1>Подводим итоги</h2><ul><li>Не бросайте систему на самотек, начинайте собирать метрики и их визуализировать как можно раньше</li><li>Заранее планируйте рост требуемых ресурсов и свои действия в случае экстренных ситуаций</li><li>Кэшируйте по максимуму все, что возможно</li><li>Все инженерные решения не вечны, ни одно из решений не идеально, но многие будут нормально работать в течение какого-то периода времени</li><li>Заранее начинайте задумываться о плане масштабирования</li><li>Не полагайтесь полностью на memcached и базу данных - они могут Вас подвести в самый неподходящий момент</li><li>Все данные для запросов в реальном времени должны находиться в памяти, диски в основном для записи</li><li>Убивайте медленные запросы (mkill) прежде, чем они убьют всю систему</li><li>Некоторые задачи могут решаться путем предварительного подсчета и анализа, но далеко не все</li><li>Приближайте вычисления к данным по возможности</li><li>Используйте не mongrel, а unicorn для RoR</li></ul><p><strong>Спасибо за внимание, <a href=/feed/ >жду Вас снова</a>! Буду рад, если Вы <a href=https://www.insight-it.ru/goto/26b8fa1/ rel=nofollow target=_blank title=http://twitter.com/blinkov>подпишитесь на меня в Twitter</a>, с удовольствием пообщаюсь со всеми читателями :)</strong></p><div class=sharrre-wrapper><div class=twitter data-url=https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/ data-text="Архитектура Twitter. Два года спустя." data-title=Tweet></div><div class=facebook data-url=https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/ data-text="Архитектура Twitter. Два года спустя." data-title=Like></div><div class=linkedin data-url=https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/ data-text="Архитектура Twitter. Два года спустя." data-title="In Share" ></div></div><div class="card-panel light-blue darken-2 light-blue-text text-lighten-4"><span class=published title=2011-03-05T20:47:00+03:00>05 марта 2011</span>&nbsp;|&nbsp;<span class="vcard author"><a class="url fn light-blue-text text-lighten-4" href=https://www.insight-it.ru/author/ > Иван Блинков </a></span>&nbsp;|&nbsp;<a href=https://www.insight-it.ru/category/highload/ class="light-blue-text text-lighten-4" > Высокие нагрузки </a></div><div class=taglist class=row><a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/apache/ > Apache </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/cassandra/ > Cassandra </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/featured/ > featured </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/flock/ > Flock </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/flockdb/ > FlockDB </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/hadoop/ > Hadoop </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/hbase/ > HBase </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/kestrel/ > Kestrel </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/memcached/ > Memcached </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/mysql/ > MySQL </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/pig/ > Pig </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/ruby/ > Ruby </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/ruby-on-rails/ > Ruby on Rails </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/scala/ > Scala </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/scribe/ > Scribe </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/twitter/ > Twitter </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/unicorn/ > Unicorn </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/arkhitektura-twitter/ > архитектура Twitter </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/internet-proekty/ > интернет-проекты </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/masshtabiruemost/ > Масштабируемость </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/sotsialnaia-set/ > социальная сеть </a>&ensp;</div></footer></article></section></div><div class=after><div id=comments></div><script type=text/javascript>
        var disqus_shortname = 'insight-it';
        var disqus_identifier = '942 http://www.insight-it.ru/?p=942';
        var disqus_url = 'https://www.insight-it.ru/highload/2011/arkhitektura-twitter-dva-goda-spustya/';
        var disqus_domain = 'disqus.com';
        var disqus_title = 'Архитектура Twitter. Два года спустя.';
        var disqus_container_id = 'comments';
        (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//insight-it.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script></div></div><div class="col hide-on-small-only m3 l2"><div class=card><a href=https://www.insight-it.ru/author><div class="card-image tooltipped" data-position=top data-delay=50 data-tooltip="Автор Insight IT"><img src=https://www.insight-it.ru/images/avatar.jpeg><span class=card-title>Иван Блинков</span></div></a></div><div class=toc-wrapper><div style="height: 1px;"><ul class="section table-of-contents"><li><a href=# title="Архитектура Twitter. Два года спустя.">Архитектура Twitter. Два года спустя.</a><li><a href=#statistika title=Статистика>Статистика</a></li><li><a href=#platforma title=Платформа>Платформа</a></li><li><a href=#oborudovanie title=Оборудование>Оборудование</a></li><li><a href=#chto-takoe-tvit title="Что такое твит?">Что такое твит?</a></li><li><a href=#arkhitektura title=Архитектура>Архитектура</a><li><a href=#unicorn title=Unicorn>Unicorn</a></li><li><a href=#rails title=Rails>Rails</a></li><li><a href=#memcached title=memcached>memcached</a></li><li><a href=#mysql title=MySQL>MySQL</a></li><li><a href=#flockdb title=FlockDB>FlockDB</a></li><li><a href=#cassandra title=Cassandra>Cassandra</a></li><li><a href=#scribe title=Scribe>Scribe</a></li><li><a href=#hadoop title=Hadoop>Hadoop</a></li><li><a href=#pig title=Pig>Pig</a></li><li><a href=#dannye title=Данные>Данные</a></li><li><a href=#hbase title=HBase>HBase</a></li><li><a href=#loony title=Loony>Loony</a></li><li><a href=#murder title=Murder>Murder</a></li><li><a href=#kestrel title=Kestrel>Kestrel</a></li><li><a href=#daemony title="Daemon'ы">Daemon'ы</a></li><li><a href=#kak-oni-spravliaiutsia-s-takimi-tempami-rosta title="Как они справляются с такими темпами роста?">Как они справляются с такими темпами роста?</a></li><li><a href=#temnyi-rezhim title режим"" темный>"Темный режим"</a></li></li><li><a href=#podvodim-itogi_1 title="Подводим итоги">Подводим итоги</a></li></li></ul></div></div></div></div></div></main><footer class=page-footer><div id=footer class=container><div class=row><div class="col m4 s12"><h5 class=white-text>Иван Блинков</h5><ul><li><a href=mailto:insight-it@blinkov.ru rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-mail white-text"></i> insight-it@blinkov.ru </span></a></li><li><a href=https://www.linkedin.com/in/ivanblinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-linkedin light-blue-text text-darken-3"></i> LinkedIn </span></a></li><li><a href=https://twitter.com/blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-twitter cyan-text text-accent-2"></i> @blinkov </span></a></li><li><a href="http://plus.google.com/102882395551389724078?rel=author" rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-gplus red-text"></i> Google </span></a></li><li><a href=https://www.facebook.com/ivan.blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-facebook blue-text text-darken-3"></i> Facebook </span></a></li><li><a href=https://www.insight-it.ru/feed/ rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-rss orange-text"></i> Подписаться по RSS </span></a></li></ul><a href=//feeds.feedburner.com/insight-it/feed target=_blank rel="external nofollow"><img src="//feeds.feedburner.com/~fc/insight-it/feed?bg=b3e5fc&amp;fg=222222&amp;anim=1" height=26 width=88></a>&nbsp;<a href=//twitter.com/blinkov target=_blank rel="external nofollow"><img src=//button.twittercounter.com/animated/blinkov/222222/b3e5fc width=88 height=26></a></div><div class="col m4 s12"><h5 class=white-text>Рубрики</h5><ul><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/highload/ > Высокие нагрузки </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/interactive/ > Интерактивные сайты </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/php/ > PHP </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/security/ > Безопасность </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/vacancy/ > Вакансии </a></li></ul><h5 class=white-text>Навигация</h5><ul><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/blog/ >Блог</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/about/ >О&nbsp;сайте</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/author/ >Об&nbsp;авторе</a></li></ul></div><div class="col m4 s12"><h5 class="white-text center-align">Теги</h5><div class="tagcloud taglist"><span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/razrabotka/ > разработка </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/tekhnologiia/ > технология </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/online/ > online </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/google/ > Google </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/java/ > Java </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/internet/ > интернет </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/linux/ > Linux </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hbase/ > HBase </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/masshtabiruemost/ > Масштабируемость </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/highload/ > highload </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/javascript/ > JavaScript </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hadoop/ > Hadoop </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/nginx/ > nginx </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/oop/ > ООП </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/meropriiatiia/ > мероприятия </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/mysql/ > MySQL </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/programmirovanie/ > Программирование </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/c/ > C++ </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/python/ > Python </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/informatsionnye-tekhnologii/ > информационные технологии </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/arkhitektura/ > архитектура </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/apache/ > Apache </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/facebook/ > Facebook </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/php/ > PHP </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/memcached/ > Memcached </a></span>&ensp;</div></div></div></div><div class=footer-copyright><div class=container> © Insight IT, 2008-2015 <a class="license right tooltipped" rel="license nofollow" target=_blank href=http://creativecommons.org/licenses/by-nc-nd/4.0/ data-position=left data-delay=50 data-tooltip="Все материалы опубликованы под лицензией Creative Commons Attribution-NonCommercial-NoDerivatives 4.0"><img alt="Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License" src=https://www.insight-it.ru/theme/images/license.png></a></div></div></footer><script src=//code.jquery.com/jquery-2.1.1.min.js></script><script src=https://www.insight-it.ru/theme/js/main.js?b5bb290d></script><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js ','ga');
ga('create', 'UA-3403373-1', 'auto');
ga('send', 'pageview');
</script></body></html>