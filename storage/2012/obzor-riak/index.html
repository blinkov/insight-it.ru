<!DOCTYPE html>
<html lang=ru xmlns=http://www.w3.org/1999/xhtml xmlns:og=http://ogp.me/ns# xmlns:fb=https://www.facebook.com/2008/fbml><head><meta http-equiv=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=msapplication-tap-highlight content=no><title>Обзор Riak</title><link href="//fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=PT+Sans&amp;subset=latin,cyrillic" rel=stylesheet type=text/css><link rel=stylesheet href=https://www.insight-it.ru/theme/css/main.css?5e55de6b><link rel=canonical href=https://www.insight-it.ru/storage/2012/obzor-riak/ ><meta property=og:url content=https://www.insight-it.ru/storage/2012/obzor-riak/ ><meta property=og:title content="Обзор Riak"><meta property=og:type content=article><meta name=description content="Riak - распределенная opensource база данных, разработанная на Erlang и спроектированная в расчете на: Высокую ..."><meta property=og:description content="Riak - распределенная opensource база данных, разработанная на Erlang и спроектированная в расчете на: Высокую ..."><meta name=keywords content="Basho,Erlang,LevelDB,Protocol Buffers,REST,Riak,БД,обзор,СУБД"><meta property=og:image content=https://www.insight-it.ru/images/riak-teaser.jpg><meta name=author content="Иван Блинков"><meta property=og:site_name content="Insight IT"><meta property=og:locale content=ru_RU><link href=https://www.insight-it.ru/feed/index.xml type=application/rss+xml rel=alternate title="Insight IT RSS Feed"></head><body><header><div class=container><a href=# data-activates=nav-mobile class="button-collapse top-nav waves-effect waves-light circle"><i class=icon-menu></i></a></div><ul id=nav-mobile class="side-nav fixed"><li class=logo><a id=logo-container href=https://www.insight-it.ru/ class=brand-logo><h4>Insight IT</h4></a></li><li class=bold><a href=https://www.insight-it.ru/highload/ > Высокие нагрузки </a></li><li class=bold><a href=https://www.insight-it.ru/interactive/ > Интерактивные сайты </a></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Рубрики </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a href=https://www.insight-it.ru/category/index/ > Все рубрики </a></li></ul></div></li></ul></li><li class=no-padding><ul class="collapsible collapsible-accordion"><li class=bold><a class="collapsible-header waves-effect waves-red"> Страницы </a><div class=collapsible-body><ul><li><a href=https://www.insight-it.ru/blog/ > Блог </a></li><li><a href=https://www.insight-it.ru/about/ > О сайте </a></li><li><a href=https://www.insight-it.ru/author/ > Об авторе </a></li><li><a href=https://www.insight-it.ru/consulting/ > Консультации </a></li><li><a href=https://www.insight-it.ru/contact/ > Контакты </a></li><li><a href=https://www.insight-it.ru/resume/ > Резюме </a></li><li><a href=https://www.insight-it.ru/search/ > Поиск по сайту </a></li></ul></div></li></ul></li></ul></header><main><nav class=top-nav><div class=container><div class=nav-wrapper><ul id=nav-mobile class="right hide-on-med-and-down"><li class><a href=/blog/ >Блог</a></li><li class><a href=/about/ >О&nbsp;сайте</a></li><li class><a href=/author/ >Об&nbsp;авторе</a></li></ul><h1><a class=page-title> Обзор Riak </a></h1></div></div></nav><div class=container><div class=row><div class="col s12 m9 l10"><div class="materialdesign section scrollspy"><section id=content class=body><article class=entry-content><div class=card><div class=card-image><img src=https://www.insight-it.ru/images/riak-teaser.jpg alt="Обзор Riak" title="Обзор Riak" class=responsive-img></div></div><p><a href=https://www.insight-it.ru/goto/243e6801/ rel=nofollow target=_blank title=http://basho.com/products/riak-kv/ >Riak</a> - распределенная <em>opensource</em>&nbsp;база данных, разработанная на <a href=/tag/erlang/ >Erlang</a> и спроектированная в расчете на:</p><ul><li><strong>Высокую доступность и устойчивость к сбоям;</strong></li><li><strong>Масштабируемость и простоту обслуживания;</strong></li><li><strong>Универсальность.</strong></li></ul><p>У проекта отличная&nbsp;<a href=https://www.insight-it.ru/goto/e20af489/ rel=nofollow target=_blank title=https://docs.basho.com/riak/latest/ >официальная документация</a>&nbsp;на английском, далее же в этой статье я расскажу об основных её особенностях чуть подробнее, а также хитростях и подводных камнях, выявленных в процессе применения на практике (с перспективы веб-разработки).</p><h2 id=vysokaia-dostupnost-i-ustoichivost-k-sboiam>Высокая доступность и устойчивость к сбоям</h2><ul><li>Все данные в кластере&nbsp;<em>реплицируются</em> по принципу соседей на хэш кольце (см. логотип для иллюстрации) и даже в случае сбоев <em>доступны</em> посредством интеллектуального перенаправления запросов внутри кластера.</li><li>В случае возникновения коллизий из-за разрыва сетевого соединения или просто одновременной записи, на запрос получения данных <em>может вернуться несколько версий</em> и приложение само может решить как их объединить или какую версию использовать.</li></ul><h2 id=masshtabiruemost-i-prostota-obsluzhivaniia>Масштабируемость и простота обслуживания</h2><ul><li>Добавление нового сервера тривиально путем копирования конфига и одной команды.</li><li>Перераспределение данных и все остальное прозрачно происходит за сценой.</li><li>Минимальный рекомендуемый размер Riak кластера - 5 серверов, меньшее количество не дает раскрыть весь потенциал.</li><li>Одинаково легко обслуживать как маленький, так и большой кластер.</li><li>Есть коммерческая <em>Enterprise</em> версия с поддержкой от <strong>Basho</strong>, компании-разработчика Riak (изначально выходцы из Akamai), равноправной зашифрованной репликацией между датацентрами и поддержкой <em>SNMP</em>.</li><li>Есть встроенный веб-интерфейс для мониторинга и управления кластером, у меня правда так и не дошли руки его освоить:</li></ul><div class=video-container><iframe allowfullscreen frameborder=0 height=480 src="//www.youtube.com/embed/R0_PLMCrtZw?rel=0" width=853></iframe></div><h2 id=universalnost>Универсальность</h2><ul><li>Схема отсутствует, ключи и данные - произвольные бинарные строки. Ключи располагаются в пространствах имен <em>(bucket)</em>.</li><li>Сериализация - на усмотрение разработчика, популярные варианты - Erlang'овский <em>BERT</em>, <em>JSON</em> для других платформ, можно использовать просто как <em>файловую систему</em>.</li><li>Модульная система хранилищ данных, альтернатив много, основная - <a href=/tag/google/ >Google</a><a href=/tag/leveldb/ >LevelDB</a>;&nbsp;еще интересный вариант с хранением полностью в оперативной памяти - получается продвинутый распределенный кэш с репликацией, поиском и пр.</li><li>Гибко настраиваемое количество узлов кластера, которые должны подтвердить успешность операции, чтобы она считалась успешной: можно указывать для всего кластера, пространства имен и даже конкретного запроса. Riak в любом случае остается eventually consistent базой данных (AP из CAP теоремы), но с возможностью управлять балансом производительности операций и надежностью выполнения запросов.</li><li>Три интерфейса доступа <em>(API)</em>:<ul><li><a href=/tag/protocol-buffers/ >Google ProtocolBuffers</a> - для основного использования в боевых условиях.</li><li><a href=/tag/http/ >HTTP</a><a href=/tag/rest/ >REST</a> - для использования в языках, где нет готового клиента на ProtocolBuffers и для того, чтобы по-быстрому что-то посмотреть из консоли через curl. Хотя по факту клиенты для большинства языков программирования есть и проще делать запросы через интерпретатор.</li><li>Еще есть прямой интерфейс Erlang-сообщений, но даже из самого Erlang им пользоваться не рекомендуют, не говоря уже о реализациях Erlang node (BERT) на других платформах.</li></ul></li><li>Вместе с данными хранятся метаданные для разных целей, которые используются в соответствующих типах запросов:<ul><li><a href=https://www.insight-it.ru/goto/3d61cc81/ rel=nofollow target=_blank title=http://ru.wikipedia.org/wiki/%D0%92%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%BD%D1%8B%D0%B5_%D1%87%D0%B0%D1%81%D1%8B>Векторные часы</a> для разрешения конфликтов версий данных&nbsp;<em>(обязательно, есть автоматическое разрешение);</em></li><li>Индекс для полнотекстного поиска <em>(концептуально позаимствован у <a href=/tag/lucene/ >Lucene</a>/<a href=/tag/solr/ >Solr</a>, опционально);</em></li><li>Индекс для простых выборок <em>(по бинарным и числовым полям, опционально);</em></li><li>Связанные ключи <em>(отдаленный аналог внешних ключей, опционально).</em></li></ul></li><li>Встроенная поддержка <a href=/tag/mapreduce/ >MapReduce</a>, фазы можно реализовывать на <a href=/tag/erlang/ >Erlang</a> или <a href=/tag/javascript/ >JavaScript</a>;&nbsp;для обоих языков есть библиотека с наиболее популярными случаями, которые можно использовать для образца.</li><li>Есть поддержка выполнения операций до/после операций записи/чтения <em>(hooks)</em>, чаще всего используются для построения полнотекстного индекса, но можно реализовать и свои, специфичные для приложения.</li></ul><h2 id=nedokumentirovannye-vozmozhnosti>Недокументированные возможности</h2><p>Пока я их нашел всего две:</p><ul><li><strong>Счетчики:</strong>&nbsp;как такового API в для&nbsp;увеличения/уменьшения числовых значений <em>(increment/decrement)</em> в Riak нет, так как он не лезет внутрь хранящихся данных. Зато есть векторные часы, которые растут с каждой операцией записи по ключу. Чтобы реализовать увеличение <em>(increment)</em> необходимо записать в Riak пустую бинарную строку с опцией <em>return_body,&nbsp;</em>и у вернувшегося значения сложить все поля в векторных часах. <a href=https://www.insight-it.ru/goto/6a894d09/ rel=nofollow target=_blank title=https://gist.github.com/4061705>Пример на Erlang</a>. Если нужно еще и уменьшение (decrement) этого можно добиться с помощью пары счетчиков "плюс и минус" и вычитать второе значение из первого. Для&nbsp;авто инкремента&nbsp;основных ключей не самый лучший вариант, но для не особо критичных случаев вполне себе работает.</li><li><strong>Выборка по списку ключей <em>(multiget)</em>:&nbsp;</strong>такого API тоже нет, но здесь на выручку приходит <em>MapReduce</em>. Это, пожалуй, наиболее популярное его применение. На вход подаем имеющийся список ключей и используем фазы из готовой библиотеки: <em>reduce_set_union</em> и <em>map_identity</em>. Данные возвращаются&nbsp;неотсортированные &nbsp;и требуют небольшой обертки на выходе, но все равно это намного быстрее, чем последовательно проходить по списку ключей и делать для каждого обычный <em>get</em>. <a href=https://www.insight-it.ru/goto/d557f797/ rel=nofollow target=_blank title=https://gist.github.com/4061784>Пример на Erlang</a>.</li></ul><div class="card blue lighten-4"><p><div class=card-content> Буду рад, если Вы поможете мне дополнить этот список, оставив известные Вам подобные трюки в комментариях. </div></p></div><h2 id=podvodnye-kamni>Подводные камни</h2><ul><li>Если в Вашем приложении необходима функциональность <strong>постраничного просмотра отсортированных данных</strong><em>(pagination)</em>, то будьте готовы реализовать её на клиенте. То есть Riak быстро сделал нужную выборку всех "страниц" и уже на клиенте её придется отсортировать и выкинуть лишнее. Вообще в большинстве случаев результаты запросов к Riak приходят в произвольном порядке из-за его распределенной природы.</li><li>В продолжение к предыдущему: в <a href=https://www.insight-it.ru/goto/1093e454/ rel=nofollow target=_blank title=https://docs.basho.com/riak/latest/dev/using/search/ >REST Solr интерфейсе</a>&nbsp;есть аргументы (в ProtoBuf это тоже добавили в одной из последних версий), которые, казалось бы, достаточны для реализации постраничного просмотра: <strong>sort</strong>, <strong>start</strong>, <strong>rows</strong> - что еще нужно? На практике оно работает не так, как было бы логично. Сортировка по значению (заданная в sort) применяется ПОСЛЕ того, как была отсчитана страница по start и rows. Они отмеряются по ключам или рейтингу значения в полнотекстном поиске и никак иначе. С тем же успехом эти 5-10 значений можно очень быстро отсортировать и на клиенте. Зачем-то это может быть и нужно, но в моем случае оказалось совершенно бесполезно.</li><li>У Riak есть 4 основных типа запросов: простой get/set,&nbsp;полнотекстовый&nbsp;поиск, вторичные ключи <em>(secondary indices)</em>, МapReduce и проход по связанным ключам <em>(link walking)</em>.<ul><li>Если Ваши данные являются сериализованным JSON, BERT или XML, то в большинстве случаев Вам нужны лишь первые два из них, исключение - упомянутая выше выборка по списку ключей через MapReduce.</li><li>Основной сценарий использования вторичных индексов - метаданные к произвольным неструктурированным бинарным данным, например в случае с аналогом файловой системы. Либо совсем примитивные случаи, когда правда нужно сделать простую выборку по одному целочисленному полю, что бывает редко.</li><li>Если данные сериализованы, то связанные ключи проще хранить внутри данных, а не средствами СУБД. Разницы в производительности нет, в итоге делается тот же MapReduce с теми же фазами.</li></ul></li><li>Хоть Riak "из коробки" и правда надежнее многих других СУБД и 1-2 упавших/отключенных сервера в кластере внешне практически не заметны, есть одно но. Если один узел упал - соединения всех подключенных к нему клиентов теряются. Два основных пути&nbsp;преодоления&nbsp;этого момента:<ul><li>Если кластер клиентов и кластер Riak расположены на разных серверах, то между ними можно поставить отказоустойчивый TCP балансировщик нагрузки, в частности <a href=/tag/haproxy/ >HAProxy</a> или <a href=/tag/ipvs/ >IPVS</a> здесь наиболее органично вписываются.</li><li>Если на одних и тех же, то есть вариант поставить балансировщик нагрузки перед клиентами (для веба возможно и в HTTP/HTTPS режиме), а каждый клиент подключается к своему локальному серверу Riak и если один, другой или оба сразу упали, то отрубать весь физический сервер целиком.</li></ul></li></ul><h2 id=vyvody>Выводы</h2><p>Riak отлично подходит для многих вариантов использования, как в Интернет среде, так и в смежных вроде телекома. Обладает отличным набором положительных "черт характера", о которых шла речь в начале статьи. Прекрасно справляется с большим потоком как операций записи, так и операций чтения.</p><p>Как уже упоминалось, практически единственный сценарий, где Riak совсем не справляется, это выборки по большим объемам данных с сортировкой и постраничным выводом. Но даже в этом случае никто не мешает использовать отдельный сервис, который будет индексировать нужным образом данные и подготавливать список идентификаторов для последующей multiget выборки из Riak. К слову, проекты по этой части уже появляются, например <a href=https://www.insight-it.ru/goto/1232aa05/ rel=nofollow target=_blank title=https://github.com/rzezeski/yokozuna>Yokozuna</a> - интеграция полноценного Solr с Riak <em>(Riak Search - лишь частичный порт Solr+Lucene на Erlang)</em>.</p><div class=sharrre-wrapper><div class=twitter data-url=https://www.insight-it.ru/storage/2012/obzor-riak/ data-text="Обзор Riak" data-title=Tweet></div><div class=facebook data-url=https://www.insight-it.ru/storage/2012/obzor-riak/ data-text="Обзор Riak" data-title=Like></div><div class=linkedin data-url=https://www.insight-it.ru/storage/2012/obzor-riak/ data-text="Обзор Riak" data-title="In Share" ></div></div><div class="card-panel light-blue darken-2 light-blue-text text-lighten-4"><span class=published title=2012-11-13T02:09:00+04:00>13 ноября 2012</span>&nbsp;|&nbsp;<span class="vcard author"><a class="url fn light-blue-text text-lighten-4" href=https://www.insight-it.ru/author/ > Иван Блинков </a></span>&nbsp;|&nbsp;<a href=https://www.insight-it.ru/category/storage/ class="light-blue-text text-lighten-4" > Хранение данных </a>&nbsp;|&nbsp;<a href=https://www.insight-it.ru/storage/2012/obzor-riak/#comments class="light-blue-text text-lighten-4" title="36 комментариев"> 36 <i class=icon-chat></i></a></div><div class=taglist class=row><a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/basho/ > Basho </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/erlang/ > Erlang </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/leveldb/ > LevelDB </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/protocol-buffers/ > Protocol Buffers </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/rest/ > REST </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/riak/ > Riak </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/bd/ > БД </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/obzor/ > обзор </a>&ensp;<a class="tag light-blue lighten-2 white-text" href=https://www.insight-it.ru/tag/subd/ > СУБД </a>&ensp;</div></footer></article></section></div><div class=after><div id=comments><h4>36 комментариев</h4><ul class=comments-list><li class=comment><em>Юрий, 2013-03-29T06:15:51:<em> Подскажите пожалуйста, обыскал весь интернет, не нашел ни одного рабочего примера поиска через riakc_pb_socket:search()Что я делаю не так?{ok, Pid} = riakc_pb_socket:start_link("127.0.0.1", 8087). Object = riakc_obj:new(<<"backet">>, <<"1">>,list_to_binary("[{name,\"123\"}]")).riakc_pb_socket:put(Pid,Object).riakc_pb_socket:search(Pid,<<"backet">>,"name:123").возвращает{ok,{search_results,[],0.0,0}}чтобы я не указал в поиске <ul class=children><li class=comment><em>Ivan Blinkov, 2013-03-29T10:18:01:<em> Очень похоже на не установленный search hook, инструкция: http://docs.basho.com/riak/lat...В поиске будут появляться только данные, записанные после выполнения указанной по ссылки команды, автоматически всю базу он не проиндексирует. <ul class=children><li class=comment><em>Юрий, 2013-03-29T10:49:55:<em> Спасибо, за совет, но пока не получилось.выполнилsearch-cmd install backetвернулось :: Installing Riak Search <--> KV hook on bucket 'backet'.после чего добавил Object4 = riakc_obj:new(<<"backet">>, <<"2">>,list_to_binary("[{name,\"56\"}]")).riakc_pb_socket:put(Pid,Object4).riakc_pb_socket:search(Pid,<<"backet">>,"name:56").эффект тот же{ok,{search_results,[],0.0,0}}может что-то не так с поисковой строкой?Вы не знаете где поискать рабочие примеры, пока натыкался только на такие же вопросы <ul class=children><li class=comment><em>Ivan Blinkov, 2013-03-29T11:13:01:<em> Вообще да, сразу не обратил внимания, list_to_binary там лишний - оно просто proplist на вход принимает. То есть там просто [{name, <<"56">>}] должно быть. <ul class=children><li class=comment><em>Юрий, 2013-03-29T11:46:38:<em> Спасибо большое, действительно дело было в этом, значит каждое value proplist-а нужно переводить в binary, то есть с русскими буквами никак не выйдет? <ul class=children><li class=comment><em>Ivan Blinkov, 2013-03-29T11:53:56:<em> Могу ошибаться, но нет, не обязательно, главное чтобы было завернуто в proplist. Он сам все конвертирует, а данные интерпретирует в зависимости от суффикса в имени поля - http://docs.basho.com/riak/lat... <ul class=children><li class=comment><em>Юрий, 2013-03-29T12:50:50:<em> если создать такой объект Object = riakc_obj:new(<<"backet">>, <<"5">>,[{name,"777"}]).riakc_pb_socket:put(Pid,Object).то он поместится, но поискriakc_pb_socket:search(Pid,<<"backet">>,"name:777").выдаст {ok,{search_results,[],0.0,0}}а если такой Object2 = riakc_obj:new(<<"backet">>, <<"7">>,[{name,list_to_binary("777")}]).то{ok,{search_results,[{<<"backet">>, [{<<"id">>,<<"7">>},{<<"name">>,<<"777">>}]}], 0.35355299711227417,1}}так что видимо русские никак, появление русской буквы в search ведет к {noproc,{gen_server,call, <ul class=children><li class=comment><em>Ivan Blinkov, 2013-03-31T08:14:56:<em> Я, если честно, не пробовал вообще с помощью Erlang или Riak делать что-либо на русском, но звучит как-то странно. По идее ничего плохого не должно случаться, если в бинарной строке окажутся русские символы в utf-8.А простые (не бинарные) строки в любом случае не стоит использовать для хранения текста. </li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li class=comment><em>Alexey Loshkarev, 2012-11-25T09:11:32:<em> А как в этих каментах уведомления на мыло получать? Это ж вроде обычный disqus, каменты у меня вроде настроены на трансляцию в мыло... А тут че-то не приходили. <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-25T12:20:10:<em> Да, это просто Disqus, подписка на комментарии по идее в начале виджета, рядом со "звездами". </li></ul></li><li class=comment><em>Pavel Drobushevich, 2012-11-13T21:31:02:<em> Очень трезвое мнение от Льва Валкина, они давно используют.http://lionet.livejournal.com/...Правда есть много нюансов, у них InnoDB, а мап-редьюс который он ругает за скорость вроде в последних версиях накачали допингом. Тем не менее интересно почитать мнение человека который давно и активно использует. Хотя в блоге basho есть много видео тоже от тех кто использует, но они слишком уж позитивные :) <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-14T20:23:45:<em> Да, интересная дискуссия, в первый раз слышу, чтобы Riak всерьез использовали с InnoDB. Так-то и правда в большинстве случаев проще использовать какую-нибудь из сборок MySQL, при необходимости с HandlerSocket.Про MapReduce и Link Walking я в своей статье тоже высказался, они ближе к multiget в memcached, чем к MapReduce в Hadoop.Amazon EC2 славится своей не особо производительной и стабильной дисковой подсистемой, так что странно, что они решили развертывать Riak кластер именно у них. Хотя если верить моему RSS, то Amazon последнее время начали что-то предпринимать для исправления данной ситуации. <ul class=children><li class=comment><em>Pavel Drobushevich, 2012-11-14T20:33:21:<em> Riak они начали использовать до того как появился LevelDB.Амазон, это амазон, они хороши, а недостатки можно обойти. Любая база на хорошем IO работает неплохо, но raid из ssd дороговато иногда :) <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-14T20:49:09:<em> До LevelDB бекендом по-умолчанию, на сколько я знаю, был Bitcask, созданный с нуля той командой, что и сам Riak (Basho). Кстати не исключено, что он и до сих пор в конфиге по-умолчанию написан, хотя некоторые функции (вторичные индексы как минимум) доступны только с LevelDB.Услуги Amazon тоже далеко не самое дешевое удовольствие. "RAID из SSD" можно один раз купить и поставить в colocation, а в Европе можно и арендовать вполне бюджетно. <ul class=children><li class=comment><em>vlm, 2012-12-26T14:46:05:<em> Мы начали использовать Riak ещё до Bitcask. Сейчас переходим на LevelDB и Bitcask. Кстати, сами башо рекомендует вот что: если ключи влезают в память — использовать Bitcask, иначе LevelDB. <ul class=children><li class=comment><em>Ivan Blinkov, 2013-01-04T08:30:41:<em> Как впечатления от перехода? Можете сравнить "до и после"? </li></ul></li></ul></li></ul></li></ul></li></ul></li><li class=comment><em>Alexey Loshkarev, 2012-11-13T13:03:55:<em> Что б сэкономить кому-то время, которое потратил я...Map-reduce там офлайновый. Условно говоря, допустим, у меня есть ключ, по этому ключу я имею миллион документов, хочу достать, по ключу, последние. Пишу map-reduce функцию, которая перебирает (при каждом запросе, итить) весь миллион, возвращает мне то что я запросил. Возвращает, соответственно, когда обсчитает. Для миллиона же документов любой map/reduce, даже самый простой, будет работать минуты, если не часы. Даже если воткнуть туда сотню нод - параллелизация-то идёт на многие ноды, но сведение результатов и отдача клиенту - на одной. Для миллиона документов сами посчитайте, сколько рамы понадобится. Соответственно, я не могу юзать прекомпилированные функции и каждый раз должен их строить заново - фильтровать по дате, например, что б уменьшать размер выдачи до разумных размеров.Я честно пытался понять, как этим пользоваться в реальной жизни, но так и не понял. Купил и прочитал две книжки - тоже не понял, и только после общения с разрабами в рассылке всё стало на места - map-reduce офлайновый, для быстрого доступа к результатам map-reduce - храните выдачу в другой базе. Собсно, redis в обоих книжках упоминается через строчку.После couchdb это было, ммм, непривычно, так скажем. В кауче map-reduce вполне себе пригодный для онлайн-запросов. Юзаю его на нескольких базах с 10-500M записей на 30-100GB - полёт отличный. Но оно и понятно, в кауче map-reduce кэшируется на диск. Первоначальный обсчёт занимает много времени, но потом любые запросы по индексу map-reduce отрабатывают за O(1). <ul class=children><li class=comment><em>Daniil Churikov, 2012-11-20T20:52:01:<em> napisal otvet kak reshit` vashu problemu, ne uveren chto on tut pojavilsia, chto to gluchit. Korotko: riak_pipes reshit vashi problemi, pravda pridetsia pisat` kod na erlang <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-20T23:00:49:<em> Это была просто премодерация комментариев со ссылками </li></ul></li><li class=comment><em>Daniil Churikov, 2012-11-20T19:44:26:<em> Алексей, хочу маленько уточнить. Я понимаю что это не очивидно, и доки у башевцев не таки хорошие как хотелось бы(ну движение идет в нужную стороно), но те проблемы которые Вы назвали(стриминг данных из большого мапредьюса) решаются довольно просто. Для этого правда придется немного пописать на эрланге.https://github.com/basho/riak_... (то что под капотом мапредьюса в риаке)Для решения Вашей проблемы придется написать кастомные фитинги. Это не тривиально, но довольно просто и там есть примеры, которые делают _почти_ то что вам нужно. <ul class=children><li class=comment><em>Alexey Loshkarev, 2012-11-25T09:08:55:<em> Дописывать базу данных - это то, чем я собираюсь заниматься в последнюю очередь, если честно. Я не верю в свои способности написать это качественно и безглючно, особенно в условиях, когда мне надо решать задачу, а не писать базу данных. Поэтому я вместо того, что б использовать riak и допиливать его до похожести на couchdb просто стал использовать couchdb. Еще и выиграл за счет меж-датацентровой репликации (бесплатной и из коробки). <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-25T12:21:25:<em> Да, вероятно для Вашей задачи и правда так сделать было проще. </li></ul></li></ul></li><li class=comment><em>afiskon, 2012-11-14T05:21:17:<em> "Купил и прочитал две книжки"Что за книжки? <ul class=children><li class=comment><em>Alexey Loshkarev, 2012-11-25T09:09:36:<em> Riak Handbook, как уже написали и "7 databases in 7 days", там тоже было про риак и мои юскейсы, но ответа там тоже не получил, на удивление. </li><li class=comment><em>Ivan Blinkov, 2012-11-14T20:06:53:<em> Вопрос хоть и не мне, но вероятно Riak Handbook: http://riakhandbook.com/ </li></ul></li><li class=comment><em>Ivan Blinkov, 2012-11-13T18:33:49:<em> Чтобы в Riak добиться результата, схожего с MapReduce Views в CouchDB, нужно воспользоваться не самим MapReduce, a механизмом hooks (http://docs.basho.com/riak/lat.... Хоть используется и несколько другая парадигма, но результат будет тем же - какой-то новый набор вычисленных значений, полученный из исходных данных в хранилище, обновляемый по мере их изменения и доступный без перебора всего хранилища. Из ограничений - pre/post commit hook необходимо установить ДО импорта данных, так как он выполняется только при операциях записи, но если данные уже есть - это тоже решаемо. <ul class=children><li class=comment><em>afiskon, 2012-11-14T05:23:24:<em> хуки если я правильно понимаю это что-то вроде тригеров в РСУБД? <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-14T20:05:52:<em> да, именно <ul class=children><li class=comment><em>Daniil Churikov, 2012-11-20T19:47:28:<em> хуки работают довольно медленно </li></ul></li></ul></li></ul></li></ul></li><li class=comment><em>afiskon, 2012-11-13T09:04:24:<em> Правильно ли я понимаю, что мы получаем key-value хранилище (которое ближе к memcached, чем к redis) с шардингом и возможностью "перемещаться по углам CAP теоремы"? Ну и плюс мелочи типа MapReduce (я так подозреваю, на замену Hadoop Riak не годится все равно?). <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-13T17:41:20:<em> У memcached и Riak из общего это хэш-кольцо и "слепота" относительно хранимых в нем данных. С Redis и правда мало общих точек, разного предназначения проекты, его логичнее сравнивать с Google LevelDB. К слову в Riak можно подключить Redis как backend через сторонний плагин (https://github.com/cstar/riak_..., правда этим думаю никто толком не пользуется. Вообще самый близкий аналог по архитектуре - Cassandra, но у нее column-based схема хранения, а Riak все же простой key/value.Еще очень важный момент - наличие Riak Search, встроенного ограниченного порта Solr + Lucene на Erlang.Реализация MapReduce и правда не применима для обработки всего массива данных, как в основном он используется в Hadoop. Основное применение, как я упоминал в статье: обработка данных по ограниченному количеству заранее известных ключей, если обработка не нужна, то получается простой multiget. <ul class=children><li class=comment><em>afiskon, 2012-11-14T05:35:48:<em> "У memcached и Riak из общего это хэш-кольцо и "слепота" относительно хранимых в нем данных"Хм... так никакого "сервера-словаря" для определения, на каком узле какие данные искать, как в случае с MongoDB, в Riak из коробки нет? А автоматический решардинг в нем предусмотрен? Если нет, то как предполагается выполнять его вручную? Что происходит, если я захотел добавить пару (десятков) узлов? <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-25T12:52:03:<em> Каких-либо особенных серверов в Riak нет, все равноправны.Данные лежат в виртуальных корзинках (vnode), количество которых задается перед первым включением кластера (изменить можно только созданием нового кластера и перекладыванием данных). Хэш-кольцо используется только чтобы разложить данные по корзинкам, какие сервера хранят какие корзинки Riak решает самостоятельно по своему алгоритму (за подробностями которого надо лезть в исходники), но тоже старается максимально равномерно их "размазать" по имеющимся узлам. Об изменениях в расположении корзинок кластер оповешается по протоколу gossip (сплетни/молва). Поиск данных происходит внутри Riak'а, то есть запрашивать можно любые данные у любого узла, а тот уже будет их искать внутри кластера, определив номер корзинки и обратившись к нужному узлу. То есть в какой-то степени каждый узел Riak является "сервером-словарем".Решардинг прозрачен, после добавления сервер(ов) он сам решает что делать и как перераспределить данные. Что удобно, но сетевую активность может огромную создавать. </li></ul></li><li class=comment><em>Ivan Blinkov, 2012-11-13T17:45:11:<em> Хотя с другой стороны, если аналитика и правда оффлайновая, то почему бы и не перелопачивать весь массив данных время от времени. </li></ul></li><li class=comment><em>Alexey Loshkarev, 2012-11-13T13:05:19:<em> Куда это вы перемещаться собрались? C тут мнимый, A и P нативный изкоробочный. Других вариантов riak не даёт. <ul class=children><li class=comment><em>Ivan Blinkov, 2012-11-13T17:28:38:<em> Да, все верно, Riak в любом случае eventually consistent = AP. Так что эта формулировка не очень удачно звучит на русском, поправил текст, чтобы понятнее было.За этой функцией, которую они называют Tunable CAP Controls, стоит возможность настроить количество узлов, которое должно прийти консенсусу для того, чтобы операция считалась успешной. Аналогичной настройкой также обладает Cassandra. Подробнее: http://docs.basho.com/riak/lat... </li></ul></li></ul></li></ul></div><script type=text/javascript>
        var disqus_shortname = 'insight-it';
        var disqus_identifier = '2147 http://www.insight-it.ru/?p=2147';
        var disqus_url = 'https://www.insight-it.ru/storage/2012/obzor-riak/';
        var disqus_domain = 'disqus.com';
        var disqus_title = 'Обзор Riak';
        var disqus_container_id = 'comments';
        (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//insight-it.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script></div></div><div class="col hide-on-small-only m3 l2"><div class=card><a href=https://www.insight-it.ru/author><div class="card-image tooltipped" data-position=top data-delay=50 data-tooltip="Автор Insight IT"><img src=https://www.insight-it.ru/images/avatar.jpeg><span class=card-title>Иван Блинков</span></div></a></div><div class=toc-wrapper><div style="height: 1px;"><ul class="section table-of-contents"><li><a href=# title="Обзор Riak">Обзор Riak</a><li><a href=#vysokaia-dostupnost-i-ustoichivost-k-sboiam title="Высокая доступность и устойчивость к сбоям">Высокая доступность и устойчивость к сбоям</a></li><li><a href=#masshtabiruemost-i-prostota-obsluzhivaniia title="Масштабируемость и простота обслуживания">Масштабируемость и простота обслуживания</a></li><li><a href=#universalnost title=Универсальность>Универсальность</a></li><li><a href=#nedokumentirovannye-vozmozhnosti title="Недокументированные возможности">Недокументированные возможности</a></li><li><a href=#podvodnye-kamni title="Подводные камни">Подводные камни</a></li><li><a href=#vyvody title=Выводы>Выводы</a></li></li></ul></div></div></div></div></div></main><footer class=page-footer><div id=footer class=container><div class=row><div class="col m4 s12"><h5 class=white-text>Иван Блинков</h5><ul><li><a href=mailto:insight-it@blinkov.ru rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-mail white-text"></i> insight-it@blinkov.ru </span></a></li><li><a href=https://www.linkedin.com/in/ivanblinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-linkedin light-blue-text text-darken-3"></i> LinkedIn </span></a></li><li><a href=https://twitter.com/blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-twitter cyan-text text-accent-2"></i> @blinkov </span></a></li><li><a href="http://plus.google.com/102882395551389724078?rel=author" rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-gplus red-text"></i> Google </span></a></li><li><a href=https://www.facebook.com/ivan.blinkov rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-facebook blue-text text-darken-3"></i> Facebook </span></a></li><li><a href=https://www.insight-it.ru/feed/ rel=nofollow><span class="light-blue-text text-lighten-4"><i class="icon-rss orange-text"></i> Подписаться по RSS </span></a></li></ul><a href=//feeds.feedburner.com/insight-it/feed target=_blank rel="external nofollow"><img src="//feeds.feedburner.com/~fc/insight-it/feed?bg=b3e5fc&amp;fg=222222&amp;anim=1" height=26 width=88></a>&nbsp;<a href=//twitter.com/blinkov target=_blank rel="external nofollow"><img src=//button.twittercounter.com/animated/blinkov/222222/b3e5fc width=88 height=26></a></div><div class="col m4 s12"><h5 class=white-text>Рубрики</h5><ul><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/highload/ > Высокие нагрузки </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/interactive/ > Интерактивные сайты </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/linux/ > Linux </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/python/ > Python </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/erlang/ > Erlang </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/storage/ > Хранение данных </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/frontend/ > Frontend </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/theory/ > Теория </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/event/ > Мероприятия </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/misc/ > Разное </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/php/ > PHP </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/security/ > Безопасность </a></li><li><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/category/vacancy/ > Вакансии </a></li></ul><h5 class=white-text>Навигация</h5><ul><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/blog/ >Блог</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/about/ >О&nbsp;сайте</a></li><li class><a rel=nofollow class="grey-text text-lighten-4" href=https://www.insight-it.ru/author/ >Об&nbsp;авторе</a></li></ul></div><div class="col m4 s12"><h5 class="white-text center-align">Теги</h5><div class="tagcloud taglist"><span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/programmirovanie/ > Программирование </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/meropriiatiia/ > мероприятия </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/masshtabiruemost/ > Масштабируемость </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/apache/ > Apache </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/informatsionnye-tekhnologii/ > информационные технологии </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/memcached/ > Memcached </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/internet/ > интернет </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/google/ > Google </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/mysql/ > MySQL </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/c/ > C++ </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/arkhitektura/ > архитектура </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hbase/ > HBase </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/tekhnologiia/ > технология </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/python/ > Python </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/javascript/ > JavaScript </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/oop/ > ООП </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/nginx/ > nginx </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/facebook/ > Facebook </a></span>&ensp;<span class="tag light-blue lighten-2 tag-4"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/highload/ > highload </a></span>&ensp;<span class="tag light-blue lighten-2 tag-2"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/php/ > PHP </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/razrabotka/ > разработка </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/hadoop/ > Hadoop </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/online/ > online </a></span>&ensp;<span class="tag light-blue lighten-2 tag-1"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/linux/ > Linux </a></span>&ensp;<span class="tag light-blue lighten-2 tag-3"><a rel=nofollow class=white-text href=https://www.insight-it.ru/tag/java/ > Java </a></span>&ensp;</div></div></div></div><div class=footer-copyright><div class=container> © Insight IT, 2008-2015 <a class="license right tooltipped" rel="license nofollow" target=_blank href=http://creativecommons.org/licenses/by-nc-nd/4.0/ data-position=top data-delay=50 data-tooltip="Все материалы опубликованы под лицензией Creative Commons Attribution-NonCommercial-NoDerivatives 4.0"><img alt="Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License" src=https://www.insight-it.ru/theme/images/license.png></a></div></div></footer><script src=//code.jquery.com/jquery-2.1.1.min.js></script><script src=https://www.insight-it.ru/theme/js/main.js?b5bb290d></script><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js ','ga');
ga('create', 'UA-3403373-1', 'auto');
ga('send', 'pageview');
</script><script type=text/javascript>(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter30650472 = new Ya.Metrika({id:30650472, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src=//mc.yandex.ru/watch/30650472 style="position:absolute; left:-9999px;" alt></div></noscript></body></html>